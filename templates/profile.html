<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>{{ profile.display_name }} ‚Äî –ü—Ä–æ—Ñ–∏–ª—å</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            --primary: #667eea;
            --primary2: #764ba2;
            --accent: #ec4899;
            --gold: #fbbf24;
            --bg: #0a0a0a;
            --bg2: #111111;
            --bg3: #1a1a1a;
            --glass: rgba(255,255,255,0.05);
            --glass2: rgba(255,255,255,0.08);
            --border: rgba(255,255,255,0.1);
            --text: #ffffff;
            --text2: #a1a1aa;
            --radius: 16px;
            --shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }


        /* ‚îÄ‚îÄ‚îÄ HERO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .profile-hero {
            position: relative;
            min-height: 380px;
            display: flex; align-items: flex-end;
            padding-top: 60px;
            overflow: hidden;
        }
        .hero-bg {
            position: absolute; inset: 0;
            background: linear-gradient(135deg, #1a0533 0%, #0d1b4b 50%, #0a1a0a 100%);
            background-size: 400% 400%;
            animation: gradientShift 12s ease infinite;
        }
        .hero-bg-img {
            position: absolute; inset: 0;
            background-size: cover; background-position: center;
            opacity: 0.35;
            transition: opacity .4s;
        }
        .hero-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(to bottom, transparent 0%, rgba(10,10,10,0.6) 60%, var(--bg) 100%);
        }
        @keyframes gradientShift {
            0%,100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Particles */
        .particles { position: absolute; inset: 0; overflow: hidden; pointer-events: none; }
        .particle {
            position: absolute;
            border-radius: 50%;
            opacity: 0;
            animation: floatUp var(--dur) ease-in-out infinite;
            animation-delay: var(--delay);
        }
        @keyframes floatUp {
            0% { opacity: 0; transform: translateY(0) scale(0); }
            20% { opacity: .6; }
            80% { opacity: .2; }
            100% { opacity: 0; transform: translateY(-260px) scale(1.5); }
        }

        .hero-content {
            position: relative; z-index: 2;
            width: 100%; max-width: 960px; margin: 0 auto;
            padding: 32px 20px 36px;
            display: flex; align-items: flex-end; gap: 28px; flex-wrap: wrap;
        }

        /* Avatar */
        .avatar-wrap { position: relative; flex-shrink: 0; }
        .avatar {
            width: 110px; height: 110px;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.2);
            box-shadow: 0 0 0 3px var(--primary), var(--shadow);
            background: linear-gradient(135deg, var(--primary), var(--primary2));
            display: flex; align-items: center; justify-content: center;
            font-size: 40px; font-weight: 700; color: white;
            overflow: hidden;
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .avatar-edit-btn {
            position: absolute; bottom: 4px; right: 4px;
            width: 30px; height: 30px; border-radius: 50%;
            background: var(--primary); border: 2px solid var(--bg);
            color: white; font-size: 13px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: transform .2s, background .2s;
        }
        .avatar-edit-btn:hover { transform: scale(1.1); background: var(--accent); }

        .hero-info { flex: 1; min-width: 200px; }
        .profile-name { font-size: 26px; font-weight: 800; text-shadow: 0 2px 8px rgba(0,0,0,0.5); line-height: 1.2; margin-bottom: 6px; }
        .profile-bio { font-size: 14px; color: var(--text2); max-width: 480px; line-height: 1.5; margin-bottom: 14px; }
        .profile-stats { display: flex; gap: 14px; flex-wrap: wrap; }
        .pstat {
            display: flex; flex-direction: column; align-items: center;
            background: var(--glass); backdrop-filter: blur(10px);
            border: 1px solid var(--border); border-radius: 12px; padding: 8px 16px; min-width: 72px;
        }
        .pstat-val { font-size: 18px; font-weight: 700; }
        .pstat-lbl { font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: .5px; }

        .hero-actions { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
        .btn-edit {
            padding: 8px 18px; border-radius: 20px;
            background: var(--glass2); border: 1px solid var(--border);
            color: var(--text); font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all .2s; display: flex; align-items: center; gap: 6px;
        }
        .btn-edit:hover { background: var(--glass); border-color: var(--primary); color: var(--primary); }
        .btn-bg { padding: 8px 18px; border-radius: 20px; background: transparent; border: 1px solid var(--border); color: var(--text2); font-size: 13px; font-weight: 500; cursor: pointer; transition: all .2s; }
        .btn-bg:hover { border-color: var(--primary); color: var(--primary); }
        .level-badge { display: inline-flex; align-items: center; gap: 6px; background: linear-gradient(135deg, var(--primary), var(--primary2)); border-radius: 20px; padding: 4px 12px; font-size: 12px; font-weight: 700; margin-bottom: 8px; }
        .premium-badge { display: inline-flex; align-items: center; gap: 5px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 20px; padding: 4px 12px; font-size: 12px; font-weight: 700; margin-left: 8px; color: #fff; vertical-align: middle; }
        .avatar-edit-btn.locked { background: #4b5563; cursor: pointer; }
        .avatar-edit-btn.locked:hover { background: var(--gold); transform: scale(1.1); }

        /* ‚îÄ‚îÄ Premium crown on avatar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .avatar-premium-crown {
            position: absolute; bottom: 2px; left: 2px;
            width: 28px; height: 28px; border-radius: 50%;
            background: linear-gradient(135deg, #f59e0b, #fbbf24, #d97706);
            border: 2px solid var(--bg);
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; line-height: 1;
            box-shadow: 0 0 10px rgba(251,191,36,.6), 0 0 20px rgba(245,158,11,.3);
            animation: crownPulse 3s ease-in-out infinite;
            z-index: 3;
        }
        @keyframes crownPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(251,191,36,.6), 0 0 20px rgba(245,158,11,.3); }
            50%       { box-shadow: 0 0 16px rgba(251,191,36,.9), 0 0 32px rgba(245,158,11,.5); }
        }
        .btn-bg.locked { color: var(--text2); opacity: 0.7; }
        .btn-bg.locked:hover { border-color: var(--gold); color: var(--gold); opacity: 1; }
        .premium-modal-icon { font-size: 52px; margin-bottom: 16px; }
        .premium-features { list-style: none; text-align: left; margin: 16px 0; }
        .premium-features li { padding: 6px 0; font-size: 13px; color: var(--text2); display: flex; align-items: center; gap: 8px; }
        .premium-features li::before { content: '‚ú¶'; color: var(--gold); font-size: 10px; flex-shrink: 0; }

        /* ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .tabs-bar {
            position: sticky; top: 60px; z-index: 90;
            background: rgba(10,10,10,0.9); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex;
        }
        .tab-btn {
            flex: 1; padding: 16px; font-size: 14px; font-weight: 600;
            color: var(--text2); background: none; border: none;
            cursor: pointer; position: relative; transition: color .2s; max-width: 200px;
        }
        .tab-btn.active { color: var(--primary); }
        .tab-btn::after { content: ''; position: absolute; bottom: 0; left: 20%; right: 20%; height: 2px; background: var(--primary); border-radius: 2px 2px 0 0; transform: scaleX(0); transition: transform .25s; }
        .tab-btn.active::after { transform: scaleX(1); }

        /* ‚îÄ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .tab-pane { display: none; max-width: 960px; margin: 0 auto; padding: 28px 20px 60px; }
        .tab-pane.active { display: block; }

        /* XP */
        .xp-card { background: var(--glass); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px 24px; margin-bottom: 20px; }
        .xp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .xp-label { font-size: 13px; color: var(--text2); }
        .xp-val { font-size: 13px; color: var(--primary); font-weight: 600; }
        .xp-track { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); border-radius: 4px; transition: width 1s cubic-bezier(.4,0,.2,1); position: relative; }
        .xp-fill::after { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 20px; background: rgba(255,255,255,0.4); animation: shimmerXp 2s ease-in-out infinite; }
        @keyframes shimmerXp { 0%,100%{opacity:0} 50%{opacity:1} }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-bottom: 24px; }
        .stat-card { background: var(--glass); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; display: flex; flex-direction: column; gap: 4px; transition: border-color .2s, transform .2s; }
        .stat-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .stat-icon { font-size: 22px; margin-bottom: 4px; }
        .bubble-icon { width: 1em; height: 1em; vertical-align: -0.15em; display: inline-block; }
        .stat-num { font-size: 22px; font-weight: 800; }
        .stat-name { font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: .5px; }

        .section-head { font-size: 16px; font-weight: 700; margin-bottom: 14px; margin-top: 28px; display: flex; align-items: center; gap: 8px; }
        .section-head:first-child { margin-top: 0; }

        /* Achievements */
        .ach-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 12px; margin-bottom: 24px; }
        .ach-item { background: var(--glass); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px 8px; display: flex; flex-direction: column; align-items: center; gap: 6px; text-align: center; transition: border-color .2s, transform .2s; cursor: default; }
        .ach-item:hover { border-color: var(--gold); transform: scale(1.04); }

        /* Quests */
        .quests-tabs { display: flex; gap: 8px; margin-bottom: 18px; }
        .quest-tab-btn { padding: 7px 20px; border-radius: 20px; background: var(--glass); border: 1px solid var(--border); color: var(--text2); font-size: 13px; font-weight: 600; cursor: pointer; transition: all .2s; }
        .quest-tab-btn.active { background: linear-gradient(135deg, var(--primary), var(--primary2)); border-color: transparent; color: #fff; }
        .quest-tab-btn:hover:not(.active) { border-color: var(--primary); color: var(--primary); }
        .quest-tab-pane { display: none; }
        .quest-tab-pane.active { display: block; }

        .quest-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
        .quest-card {
          background: var(--bg3); border: 1px solid var(--border); border-radius: 16px;
          padding: 16px 16px 14px; display: flex; flex-direction: column; gap: 12px;
          position: relative; transition: border-color .2s, transform .2s; overflow: hidden;
        }
        .quest-card:hover { border-color: rgba(102,126,234,.4); transform: translateY(-2px); }
        .quest-card.done { border-color: rgba(34,197,94,.25); }
        .quest-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, var(--primary), var(--accent)); }
        .quest-card.done::before { background: linear-gradient(90deg, #22c55e, #16a34a); }

        .quest-card-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; }
        .quest-card-icon { font-size: 28px; line-height: 1; flex-shrink: 0; }
        .quest-card-icon img { width: 36px; height: 36px; border-radius: 10px; object-fit: cover; }
        .quest-card-badge-new { background: var(--bg4); border: 1px solid var(--border2); border-radius: 20px; font-size: 10px; font-weight: 700; padding: 2px 8px; color: var(--text2); letter-spacing: .4px; flex-shrink: 0; }
        .quest-card-badge-done { background: rgba(34,197,94,.15); border: 1px solid rgba(34,197,94,.3); border-radius: 20px; font-size: 10px; font-weight: 700; padding: 2px 8px; color: #22c55e; letter-spacing: .4px; flex-shrink: 0; }

        .quest-card-title { font-size: 14px; font-weight: 700; line-height: 1.3; }
        .quest-card-desc { font-size: 12px; color: var(--text2); line-height: 1.4; margin-top: 2px; }

        .quest-rewards { display: flex; gap: 8px; flex-wrap: wrap; }
        .quest-reward-badge { display: flex; align-items: center; gap: 6px; border-radius: 10px; padding: 6px 10px; min-width: 60px; }
        .quest-reward-badge.xp { background: rgba(34,197,94,.12); border: 1px solid rgba(34,197,94,.2); }
        .quest-reward-badge.coins { background: rgba(251,191,36,.1); border: 1px solid rgba(251,191,36,.2); }
        .quest-reward-icon { width: 26px; height: 26px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
        .quest-reward-badge.xp .quest-reward-icon { background: rgba(34,197,94,.2); }
        .quest-reward-badge.coins .quest-reward-icon { background: rgba(251,191,36,.18); }
        .quest-reward-val { font-size: 16px; font-weight: 800; }
        .quest-reward-badge.xp .quest-reward-val { color: #22c55e; }
        .quest-reward-badge.coins .quest-reward-val { color: #fbbf24; }

        .quest-progress-meta { display: flex; justify-content: space-between; font-size: 11px; color: var(--text3); margin-bottom: 5px; }
        .quest-progress-meta span:last-child { color: var(--text2); font-weight: 600; }
        .quest-bar-bg { height: 5px; background: rgba(255,255,255,.08); border-radius: 99px; overflow: hidden; }
        .quest-bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); border-radius: 99px; transition: width .7s cubic-bezier(.4,0,.2,1); }
        .quest-card.done .quest-bar-fill { background: linear-gradient(90deg, #22c55e, #16a34a); }
        .ach-icon { font-size: 28px; }
        .ach-name { font-size: 10px; color: var(--text2); line-height: 1.3; }
        .ach-empty { color: var(--text2); font-size: 14px; padding: 20px 0; }

        /* ‚îÄ‚îÄ‚îÄ LIBRARY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .lib-tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
        .lib-btn { padding: 8px 20px; border-radius: 20px; background: var(--glass); border: 1px solid var(--border); color: var(--text2); font-size: 13px; font-weight: 600; cursor: pointer; transition: all .2s; }
        .lib-btn.active { background: linear-gradient(135deg, var(--primary), var(--primary2)); border-color: transparent; color: white; }
        .lib-btn:hover:not(.active) { border-color: var(--primary); color: var(--primary); }
        .lib-pane { display: none; }
        .lib-pane.active { display: block; }

        /* Manga cards */
        .manga-grid-lib { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 14px; }
        .mcard { background: var(--glass); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; cursor: pointer; transition: transform .2s, border-color .2s; position: relative; }
        .mcard:hover { transform: translateY(-4px); border-color: var(--primary); }
        .mcard-img { width: 100%; aspect-ratio: 2/3; object-fit: cover; background: var(--bg3); display: block; }
        .mcard-info { padding: 8px 10px 10px; }
        .mcard-title { font-size: 12px; font-weight: 600; line-height: 1.3; margin-bottom: 4px; }
        .mcard-meta { font-size: 10px; color: var(--text2); }
        .mcard-remove { position: absolute; top: 6px; right: 6px; width: 24px; height: 24px; border-radius: 50%; background: rgba(239,68,68,0.85); border: none; color: white; font-size: 12px; cursor: pointer; display: none; align-items: center; justify-content: center; transition: transform .2s; }
        .mcard:hover .mcard-remove { display: flex; }
        .mcard-remove:hover { transform: scale(1.15); }

        /* History */
        .history-list { display: flex; flex-direction: column; gap: 10px; }
        .hitem { display: flex; align-items: center; gap: 14px; background: var(--glass); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px 16px; cursor: pointer; transition: border-color .2s, transform .2s; text-decoration: none; color: inherit; }
        .hitem:hover { border-color: var(--primary); transform: translateX(4px); }
        .hitem-cover { width: 44px; height: 60px; border-radius: 8px; object-fit: cover; background: var(--bg3); flex-shrink: 0; }
        .hitem-info { flex: 1; min-width: 0; }
        .hitem-title { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .hitem-chap { font-size: 12px; color: var(--text2); margin-top: 3px; }
        .hitem-date { font-size: 11px; color: var(--text2); flex-shrink: 0; }

        /* Collections */
        .coll-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .btn-create { padding: 8px 18px; border-radius: 20px; background: linear-gradient(135deg, var(--primary), var(--primary2)); border: none; color: white; font-size: 13px; font-weight: 600; cursor: pointer; transition: opacity .2s, transform .2s; display: flex; align-items: center; gap: 6px; }
        .btn-create:hover { opacity: .85; transform: translateY(-1px); }
        .coll-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
        .coll-card { background: var(--glass); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; cursor: pointer; transition: transform .2s, border-color .2s; }
        .coll-card:hover { transform: translateY(-4px); border-color: var(--primary); }
        .coll-cover { height: 90px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary2) 100%); display: flex; align-items: center; justify-content: center; font-size: 32px; }
        .coll-body { padding: 12px 14px; }
        .coll-name { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
        .coll-desc { font-size: 12px; color: var(--text2); margin-bottom: 8px; line-height: 1.4; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .coll-meta { display: flex; justify-content: space-between; align-items: center; }
        .coll-count { font-size: 11px; color: var(--primary); font-weight: 600; }
        .coll-actions { display: flex; gap: 6px; }
        .coll-btn { width: 26px; height: 26px; border-radius: 50%; background: var(--glass2); border: 1px solid var(--border); color: var(--text2); font-size: 12px; cursor: pointer; transition: all .2s; display: flex; align-items: center; justify-content: center; }
        .coll-btn:hover { border-color: var(--primary); color: var(--primary); }
        .coll-btn.del:hover { border-color: #ef4444; color: #ef4444; }
        .coll-detail-back { display: flex; align-items: center; gap: 8px; color: var(--text2); cursor: pointer; font-size: 14px; margin-bottom: 20px; width: fit-content; transition: color .2s; }
        .coll-detail-back:hover { color: var(--primary); }

        /* ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .modal-overlay { position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.75); backdrop-filter: blur(6px); display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; pointer-events: none; transition: opacity .25s; }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal { background: #161616; border: 1px solid var(--border); border-radius: 20px; padding: 28px; width: 100%; max-width: 420px; transform: translateY(20px) scale(.97); transition: transform .25s; max-height: 90vh; overflow-y: auto; }
        .modal-overlay.open .modal { transform: none; }
        .modal-title { font-size: 18px; font-weight: 800; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .modal-close { width: 32px; height: 32px; border-radius: 50%; background: var(--glass); border: 1px solid var(--border); color: var(--text2); cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: all .2s; }
        .modal-close:hover { background: #ef4444; border-color: #ef4444; color: white; }
        .field { margin-bottom: 16px; }
        .field label { display: block; font-size: 13px; color: var(--text2); margin-bottom: 6px; font-weight: 500; }
        .field input, .field textarea { width: 100%; padding: 10px 14px; background: var(--glass); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 14px; font-family: inherit; outline: none; transition: border-color .2s; }
        .field input:focus, .field textarea:focus { border-color: var(--primary); }
        .field textarea { resize: vertical; min-height: 80px; }
        .field-file-wrap { border: 2px dashed var(--border); border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; transition: border-color .2s; }
        .field-file-wrap:hover { border-color: var(--primary); }
        .field-file-wrap input[type=file] { display: none; }
        .file-label { font-size: 13px; color: var(--text2); }
        .file-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin: 8px auto; display: block; }
        .file-preview-bg { width: 100%; height: 80px; border-radius: 10px; object-fit: cover; margin: 8px auto; display: block; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-primary-m { flex: 1; padding: 11px; border-radius: 12px; background: linear-gradient(135deg, var(--primary), var(--primary2)); border: none; color: white; font-size: 14px; font-weight: 700; cursor: pointer; transition: opacity .2s; }
        .btn-primary-m:hover { opacity: .85; }
        .btn-secondary-m { padding: 11px 18px; border-radius: 12px; background: var(--glass); border: 1px solid var(--border); color: var(--text2); font-size: 14px; cursor: pointer; transition: all .2s; }
        .btn-secondary-m:hover { color: var(--text); }
        .toggle-row { display: flex; align-items: center; justify-content: space-between; }
        .toggle { position: relative; width: 44px; height: 24px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; inset: 0; border-radius: 12px; background: var(--glass2); cursor: pointer; transition: background .2s; }
        .toggle-slider::before { content: ''; position: absolute; left: 3px; top: 3px; width: 18px; height: 18px; border-radius: 50%; background: white; transition: transform .2s; }
        .toggle input:checked + .toggle-slider { background: var(--primary); }
        .toggle input:checked + .toggle-slider::before { transform: translateX(20px); }

        /* ‚îÄ‚îÄ‚îÄ EDIT PROFILE MODAL TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .modal-wide { max-width: 520px !important; }
        .edit-tabs { display: flex; gap: 6px; margin-bottom: 20px; flex-wrap: wrap; }
        .edit-tab { flex: 1; padding: 8px; background: var(--glass); border: 1px solid var(--border); border-radius: 10px; color: var(--text2); font-size: 13px; font-weight: 600; cursor: pointer; transition: all .2s; font-family: inherit; }
        .edit-tab.active { background: linear-gradient(135deg, var(--primary), var(--primary2)); border-color: transparent; color: white; }
        .edit-pane { display: none; }
        .edit-pane.active { display: block; }

        /* Shop items grid inside modal */
        .shop-items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; margin-top: 4px; }
        .sitem { background: var(--bg3); border: 2px solid var(--border); border-radius: 12px; overflow: hidden; cursor: pointer; transition: border-color .2s; }
        .sitem.equipped { border-color: var(--primary); }
        .sitem-preview { height: 70px; display: flex; align-items: center; justify-content: center; font-size: 2rem; background: #0d0d0d; position: relative; }
        .sitem-name { font-size: 11px; font-weight: 600; text-align: center; padding: 5px 4px; color: var(--text2); }
        .sitem-badge { position: absolute; top: 4px; right: 4px; font-size: 9px; background: var(--primary); color: #fff; border-radius: 6px; padding: 1px 5px; font-weight: 700; }
        /* Avatar grid ‚Äî –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –∫—Ä—É–≥–ª—ã–º –ø—Ä–µ–≤—å—é */
        .shop-items-grid-avatar { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; margin-top: 4px; }
        .shop-items-grid-avatar .sitem { border-radius: 14px; }
        .shop-items-grid-avatar .sitem-preview { height: 90px; }
        .shop-items-grid-avatar .sitem-preview img { width: 66px; height: 66px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(102,126,234,.4); box-shadow: 0 0 12px rgba(102,126,234,.25); }
        .shop-items-grid-avatar .sitem.equipped { border-color: var(--primary); box-shadow: 0 0 0 1px var(--primary), 0 0 16px rgba(102,126,234,.3); }
        .sitem-empty { color: var(--text2); font-size: 13px; padding: 24px; text-align: center; grid-column: 1/-1; }

        /* XP tooltip */
        .xp-track { position: relative; }
        .xp-tooltip { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #222; border: 1px solid var(--border); border-radius: 6px; padding: 3px 8px; font-size: 12px; font-weight: 700; color: var(--text); white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity .2s; }
        .xp-track:hover .xp-tooltip { opacity: 1; }

        /* Premium lock notice */
        .premium-lock-notice { text-align: center; padding: 24px; color: var(--text2); background: var(--glass); border-radius: 12px; margin-bottom: 8px; }

        /* Utils */
        .loading-spin { display: flex; justify-content: center; padding: 40px; }
        .spin { width: 36px; height: 36px; border-radius: 50%; border: 3px solid var(--border); border-top-color: var(--primary); animation: spin .8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 48px 20px; color: var(--text2); font-size: 14px; }
        .empty-icon { font-size: 48px; margin-bottom: 12px; }

        .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px); background: #1f1f1f; border: 1px solid var(--border); border-radius: 12px; padding: 12px 20px; font-size: 14px; z-index: 300; transition: transform .3s; white-space: nowrap; }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.success { border-color: #22c55e; color: #22c55e; }
        .toast.error { border-color: #ef4444; color: #ef4444; }

        @media (max-width: 600px) {
            .hero-content { flex-direction: column; align-items: flex-start; padding: 24px 16px 28px; }
            .profile-name { font-size: 22px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .manga-grid-lib { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
            .coll-grid { grid-template-columns: 1fr 1fr; }
            .tab-pane { padding: 20px 14px 48px; }
        }
    </style>
</head>
<body>

<!-- HEADER -->
{% set g_active = 'profile' %}{% include 'header.html' %}

<!-- HERO -->
<div class="profile-hero">
    <div class="hero-bg"></div>
    <div class="hero-bg-img" id="heroBgImg"
         {% if profile.profile and profile.profile.background_url %}
         style="background-image:url('{{ profile.profile.background_url }}')"
         {% endif %}></div>
    <div class="hero-overlay"></div>
    <div class="particles" id="particles"></div>

    <div class="hero-content">
        <div class="avatar-wrap">
            <div class="avatar" id="avatarEl">
                {% if profile.profile and profile.profile.avatar_url %}
                <img src="{{ profile.profile.avatar_url }}" alt="Avatar" onerror="this.style.display='none'">
                {% else %}
                {{ profile.display_name[0]|upper }}
                {% endif %}
            </div>
            {% if profile.user.is_premium %}
            <div class="avatar-premium-crown" title="Premium">üëë</div>
            {% endif %}
            {% if is_own %}
            <button class="avatar-edit-btn" onclick="openEditModal('avatar')" title="–°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä">üì∑</button>
            {% endif %}
        </div>

        <div class="hero-info">
            <div>
                <span class="level-badge">‚ö° –£—Ä–æ–≤–µ–Ω—å {{ profile.level }}</span>
                {% if profile.user.is_premium %}<span class="premium-badge">‚≠ê Premium</span>{% endif %}
            </div>
            <h1 class="profile-name">{{ profile.display_name }}</h1>
            <p class="profile-bio" id="heroBio">{{ profile.profile.bio if profile.profile and profile.profile.bio else '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è' }}</p>
            <div class="profile-stats">
                <div class="pstat">
                    <span class="pstat-val">{{ profile.stats.total_chapters_read or 0 }}</span>
                    <span class="pstat-lbl">–ì–ª–∞–≤</span>
                </div>
                <div class="pstat">
                    <span class="pstat-val">{{ profile.xp }}</span>
                    <span class="pstat-lbl">XP</span>
                </div>
                <div class="pstat">
                    <span class="pstat-val"><img src="/static/bubbles.svg" class="bubble-icon" alt="">{{ profile.coins }}</span>
                    <span class="pstat-lbl">–®–∞—Ä–∏–∫–∏</span>
                </div>
            </div>
            {% if is_own %}
            <div class="hero-actions">
                <button class="btn-edit" onclick="openEditModal('main')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- TABS -->
<div class="tabs-bar">
    <button class="tab-btn active" data-tab="profile">üìä –ü—Ä–æ—Ñ–∏–ª—å</button>
    <button class="tab-btn" data-tab="library">üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</button>
</div>

<!-- –ü–†–û–§–ò–õ–¨ -->
<div id="tab-profile" class="tab-pane active">
    <div class="xp-card">
        <div class="xp-header">
            <span class="xp-label">–ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —É—Ä–æ–≤–Ω—è {{ profile.level + 1 }}</span>
            <span class="xp-val">{{ profile.xp_for_next }} XP –æ—Å—Ç–∞–ª–æ—Å—å</span>
        </div>
        <div class="xp-track" id="xpTrack" title="{{ profile.xp_progress_pct }}%"><div class="xp-fill" id="xpFill" style="width:0%"></div><div class="xp-tooltip" id="xpTooltip">{{ profile.xp_progress_pct }}%</div></div>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><span class="stat-icon">üìñ</span><span class="stat-num">{{ profile.stats.total_chapters_read or 0 }}</span><span class="stat-name">–ì–ª–∞–≤ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ</span></div>
        <div class="stat-card"><span class="stat-icon">üìÑ</span><span class="stat-num">{{ profile.stats.total_pages_read or 0 }}</span><span class="stat-name">–°—Ç—Ä–∞–Ω–∏—Ü</span></div>
        <div class="stat-card"><span class="stat-icon">‚ö°</span><span class="stat-num">{{ profile.xp }}</span><span class="stat-name">–û–ø—ã—Ç</span></div>
        <div class="stat-card"><span class="stat-icon"><img src="/static/bubbles.svg" style="width:24px;height:24px;vertical-align:middle" alt=""></span><span class="stat-num">{{ profile.coins }}</span><span class="stat-name">–®–∞—Ä–∏–∫–∏</span></div>
    </div>

    <div class="section-head">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è <span style="font-size:13px;color:var(--text2);font-weight:400">({{ profile.achievements|length }})</span></div>
    {% if profile.achievements %}
    <div class="ach-grid">
        {% for a in profile.achievements %}
        <div class="ach-item" title="{{ a.description }}">
            {% if a.icon_url %}<img src="{{ a.icon_url }}" style="width:36px;height:36px;border-radius:8px;object-fit:cover;margin-bottom:4px" alt="">
            {% else %}<span class="ach-icon">{{ a.icon }}</span>{% endif %}
            <span class="ach-name">{{ a.name }}</span>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="ach-empty">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π. –ß–∏—Ç–∞–π –º–∞–Ω–≥—É ‚Äî –ø–æ–ª—É—á–∞–π –Ω–∞–≥—Ä–∞–¥—ã!</p>
    {% endif %}

    {% if is_own %}
    <div class="section-head" style="margin-bottom:12px">üìã –ó–∞–¥–∞–Ω–∏—è</div>
    <div id="quests-container">
      <div class="quests-tabs">
        <button class="quest-tab-btn active" onclick="switchQuestTab('active',this)">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
        <button class="quest-tab-btn" onclick="switchQuestTab('done',this)">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
      </div>
      <div id="qtab-active" class="quest-tab-pane active"><div class="loading-spin"><div class="spin"></div></div></div>
      <div id="qtab-done" class="quest-tab-pane"></div>
    </div>
    {% endif %}
</div>

<!-- –ë–ò–ë–õ–ò–û–¢–ï–ö–ê -->
<div id="tab-library" class="tab-pane">
    <div class="lib-tabs">
        {% if is_own %}<button class="lib-btn active" data-lib="history">üìú –ò—Å—Ç–æ—Ä–∏—è</button>{% endif %}
        <button class="lib-btn{% if not is_own %} active{% endif %}" data-lib="subscriptions">üîî –ü–æ–¥–ø–∏—Å–∫–∏</button>
        <button class="lib-btn" data-lib="collections">üìÅ –ö–æ–ª–ª–µ–∫—Ü–∏–∏</button>
    </div>

    {% if is_own %}
    <div id="lib-history" class="lib-pane active">
        <div id="historyContent"><div class="loading-spin"><div class="spin"></div></div></div>
    </div>
    {% endif %}
    <div id="lib-subscriptions" class="lib-pane{% if not is_own %} active{% endif %}">
        <div id="subsContent"><div class="loading-spin"><div class="spin"></div></div></div>
    </div>
    <div id="lib-collections" class="lib-pane">
        {% if is_own %}
        <div class="coll-header">
            <span style="font-size:15px;font-weight:700">–ú–æ–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</span>
            <button class="btn-create" onclick="openModal('collModal')">Ôºã –°–æ–∑–¥–∞—Ç—å</button>
        </div>
        {% endif %}
        <div id="collsContent"><div class="loading-spin"><div class="spin"></div></div></div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê -->
{% if is_own %}
<!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å (–µ–¥–∏–Ω—ã–π modal —Å —Ç–∞–±–∞–º–∏) -->
<div class="modal-overlay" id="editProfileModal">
    <div class="modal modal-wide">
        <div class="modal-title">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å <button class="modal-close" onclick="closeModal('editProfileModal')">‚úï</button></div>

        <!-- –¢–∞–±—ã -->
        <div class="edit-tabs">
            <button class="edit-tab active" data-etab="main" onclick="switchEditTab('main')">–û—Å–Ω–æ–≤–Ω–æ–µ</button>
            <button class="edit-tab" data-etab="avatar" onclick="switchEditTab('avatar')">–ê–≤–∞—Ç–∞—Ä</button>
            <button class="edit-tab" data-etab="frame" onclick="switchEditTab('frame')">–†–∞–º–∫–∞</button>
            <button class="edit-tab" data-etab="bg" onclick="switchEditTab('bg')">–§–æ–Ω</button>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–µ -->
        <div class="edit-pane active" id="epane-main">
            <div class="field">
                <label>–ò–º—è –ø—Ä–æ—Ñ–∏–ª—è</label>
                <input type="text" id="nameInput" maxlength="50"
                       value="{{ profile.profile.custom_name if profile.profile and profile.profile.custom_name else '' }}"
                       placeholder="{{ profile.display_name }}">
                <div style="font-size:11px;color:var(--text2);margin-top:4px">–û—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º ‚Äî –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∏–º—è Telegram</div>
            </div>
            <div class="field">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</label>
                <textarea id="bioInput" maxlength="300" placeholder="–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ...">{{ profile.profile.bio if profile.profile and profile.profile.bio else '' }}</textarea>
                <div style="font-size:11px;color:var(--text2);text-align:right;margin-top:4px"><span id="bioCount">0</span>/300</div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary-m" onclick="closeModal('editProfileModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-primary-m" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>

        <!-- –ê–≤–∞—Ç–∞—Ä -->
        <div class="edit-pane" id="epane-avatar">
            {% if profile.user.is_premium %}
            <div class="field">
                <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–π –∞–≤–∞—Ç–∞—Ä</label>
                <div class="field-file-wrap" onclick="document.getElementById('avatarFile').click()">
                    <input type="file" id="avatarFile" accept="image/*" onchange="previewFile(this,'avatarPreview','circle')">
                    <img id="avatarPreview" class="file-preview" style="display:none;border-radius:50%">
                    <p class="file-label">–ù–∞–∂–º–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ<br><span style="font-size:11px;opacity:.7">JPG, PNG, WEBP –¥–æ 5 –ú–ë</span></p>
                </div>
            </div>
            <div class="modal-actions" style="margin-bottom:16px">
                <button class="btn-primary-m" onclick="uploadAvatar()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</button>
            </div>
            {% else %}
            <div class="premium-lock-notice" style="margin-bottom:16px">
                <div style="font-size:2rem;margin-bottom:8px">üîí</div>
                <div style="font-weight:700;margin-bottom:6px">–¢—Ä–µ–±—É–µ—Ç—Å—è Premium</div>
                <div style="font-size:13px;color:var(--text2)">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ Premium –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.</div>
            </div>
            {% endif %}
            <label style="font-size:13px;font-weight:600;color:var(--text2);display:block;margin-bottom:8px">–ê–≤–∞—Ç–∞—Ä—ã –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞</label>
            <div id="avatarItemsGrid" class="shop-items-grid-avatar"></div>
        </div>

        <!-- –†–∞–º–∫–∞ -->
        <div class="edit-pane" id="epane-frame">
            <div id="frameItemsGrid" class="shop-items-grid"></div>
        </div>

        <!-- –§–æ–Ω -->
        <div class="edit-pane" id="epane-bg">
            {% if profile.user.is_premium %}
            <div class="field">
                <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–π —Ñ–æ–Ω</label>
                <div class="field-file-wrap" onclick="document.getElementById('bgFile').click()">
                    <input type="file" id="bgFile" accept="image/*" onchange="previewFile(this,'bgPreview','rect')">
                    <img id="bgPreview" class="file-preview-bg" style="display:none">
                    <p class="file-label">–ù–∞–∂–º–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è<br><span style="font-size:11px;opacity:.7">JPG, PNG, WEBP –¥–æ 10 –ú–ë</span></p>
                </div>
            </div>
            <div class="modal-actions" style="margin-bottom:16px">
                <button class="btn-primary-m" onclick="uploadBg()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ–Ω</button>
            </div>
            {% else %}
            <div class="premium-lock-notice" style="margin-bottom:16px">
                <div style="font-size:2rem;margin-bottom:8px">üîí</div>
                <div style="font-weight:700;margin-bottom:6px">–¢—Ä–µ–±—É–µ—Ç—Å—è Premium –¥–ª—è —Å–≤–æ–µ–≥–æ —Ñ–æ–Ω–∞</div>
            </div>
            {% endif %}
            <label style="font-size:13px;font-weight:600;color:var(--text2);display:block;margin-bottom:8px">–ö—É–ø–ª–µ–Ω–Ω—ã–µ —Ñ–æ–Ω—ã –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞</label>
            <div id="bgItemsGrid" class="shop-items-grid"></div>
        </div>
    </div>
</div>

<!-- –ö–æ–ª–ª–µ–∫—Ü–∏—è -->
<div class="modal-overlay" id="collModal">
    <div class="modal">
        <div class="modal-title"><span id="collModalTitle">üìÅ –ù–æ–≤–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è</span> <button class="modal-close" onclick="closeModal('collModal')">‚úï</button></div>
        <div class="field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label><input type="text" id="collName" maxlength="100" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –õ—é–±–∏–º—ã–µ isekai"></div>
        <div class="field"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="collDesc" maxlength="500" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ..."></textarea></div>
        <div class="field">
            <div class="toggle-row">
                <label style="margin:0;font-size:13px;color:var(--text2)">–ü—É–±–ª–∏—á–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è</label>
                <label class="toggle"><input type="checkbox" id="collPublic" checked><span class="toggle-slider"></span></label>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-secondary-m" onclick="closeModal('collModal')">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn-primary-m" id="collSaveBtn" onclick="saveCollection()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>
</div>
{% endif %}

<div class="toast" id="toast"></div>

<script>
    const IS_OWN = {{ 'true' if is_own else 'false' }};
    const IS_PREMIUM = {{ 'true' if profile.user.is_premium else 'false' }};
    const PROFILE_USER_ID = {{ profile.user.id }};
    const XP_PCT = {{ profile.xp_progress_pct }};
    const OWNED_ITEMS = {{ profile['items'] | tojson }};

    // Particles
    (function() {
        const wrap = document.getElementById('particles');
        const colors = ['#667eea','#764ba2','#ec4899','#fbbf24','#22c55e'];
        for (let i = 0; i < 20; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            const size = 3 + Math.random() * 7;
            p.style.cssText = `width:${size}px;height:${size}px;left:${Math.random()*100}%;bottom:-10px;background:${colors[i%colors.length]};--dur:${4+Math.random()*7}s;--delay:${Math.random()*7}s;`;
            wrap.appendChild(p);
        }
    })();

    // XP fill
    setTimeout(() => { document.getElementById('xpFill').style.width = XP_PCT + '%'; }, 300);

    // Quests
    let _allQuests = [];

    function renderQuestCard(q) {
        const done = !!q.completed_at;
        const pct = Math.min(100, q.condition_value > 0 ? Math.round((q.progress / q.condition_value) * 100) : 0);
        const iconHtml = q.icon_url
            ? `<img src="${esc(q.icon_url)}" alt="">`
            : `<span>${esc(q.icon || 'üìã')}</span>`;
        const badge = done
            ? `<span class="quest-card-badge-done">‚úì –ì–æ—Ç–æ–≤–æ</span>`
            : `<span class="quest-card-badge-new">–£—Ä. ${q.required_level}+</span>`;
        const rewards = [];
        if (q.xp_reward) rewards.push(`<div class="quest-reward-badge xp"><div class="quest-reward-icon">‚ö°</div><span class="quest-reward-val">${q.xp_reward}</span></div>`);
        if (q.coins_reward) rewards.push(`<div class="quest-reward-badge coins"><div class="quest-reward-icon"><img src="/static/bubbles.svg"  alt=""></div><span class="quest-reward-val">${q.coins_reward}</span></div>`);
        return `
        <div class="quest-card${done ? ' done' : ''}">
          <div class="quest-card-top">
            <div class="quest-card-icon">${iconHtml}</div>
            ${badge}
          </div>
          <div>
            <div class="quest-card-title">${esc(q.title)}</div>
            ${q.description ? `<div class="quest-card-desc">${esc(q.description)}</div>` : ''}
          </div>
          ${rewards.length ? `<div class="quest-rewards">${rewards.join('')}</div>` : ''}
          <div>
            <div class="quest-progress-meta">
              <span>${done ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' : '–ü—Ä–æ–≥—Ä–µ—Å—Å'}</span>
              <span>${q.progress} –∏–∑ ${q.condition_value}</span>
            </div>
            <div class="quest-bar-bg"><div class="quest-bar-fill" style="width:${pct}%"></div></div>
          </div>
        </div>`;
    }

    function renderQuestTab(tab) {
        const active = _allQuests.filter(q => !q.completed_at);
        const done   = _allQuests.filter(q => !!q.completed_at);
        const list = tab === 'active' ? active : done;
        const el = document.getElementById(`qtab-${tab}`);
        if (!list.length) {
            el.innerHTML = `<p class="ach-empty">${tab === 'active' ? '–í—Å–µ –∑–∞–¥–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã! üéâ' : '–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.'}</p>`;
            return;
        }
        el.innerHTML = `<div class="quest-cards">${list.map(renderQuestCard).join('')}</div>`;
    }

    function switchQuestTab(tab, btn) {
        document.querySelectorAll('.quest-tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.quest-tab-pane').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(`qtab-${tab}`).classList.add('active');
        renderQuestTab(tab);
    }

    (function loadQuests() {
        fetch('/api/user/quests')
            .then(r => r.json())
            .then(data => {
                _allQuests = data.quests || [];
                if (!_allQuests.length) {
                    document.getElementById('qtab-active').innerHTML = '<p class="ach-empty">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π.</p>';
                    return;
                }
                renderQuestTab('active');
            })
            .catch(() => {
                document.getElementById('qtab-active').innerHTML = '<p class="ach-empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π.</p>';
            });
    })();

    // Main tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            if (btn.dataset.tab === 'library') initLibrary();
        });
    });

    // Library sub-tabs
    const libLoaded = {};
    document.querySelectorAll('.lib-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.lib-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.lib-pane').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('lib-' + btn.dataset.lib).classList.add('active');
            loadLibPane(btn.dataset.lib);
        });
    });

    function initLibrary() { loadLibPane(IS_OWN ? 'history' : 'subscriptions'); }
    function loadLibPane(name) {
        if (libLoaded[name]) return;
        libLoaded[name] = true;
        if (name === 'history') fetchHistory();
        else if (name === 'subscriptions') fetchSubs();
        else if (name === 'collections') fetchColls();
    }

    // History (—Ç–æ–ª—å–∫–æ —Å–≤–æ—è)
    function fetchHistory() {
        fetch('/api/user/history?limit=50')
            .then(r => r.json())
            .then(rows => {
                const el = document.getElementById('historyContent');
                if (!rows.length) { el.innerHTML = emptyState('üìú', '–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞', '–ù–∞—á–Ω–∏ —á–∏—Ç–∞—Ç—å –º–∞–Ω–≥—É!'); return; }
                el.innerHTML = '<div class="history-list">' + rows.map(r => `
                    <a href="/read/${esc(r.manga_slug)}/${esc(r.chapter_slug)}" class="hitem">
                        <img src="${esc(r.cover_url)}" class="hitem-cover" onerror="this.src='https://via.placeholder.com/44x60/1a1a1a/667eea'">
                        <div class="hitem-info">
                            <div class="hitem-title">${esc(r.manga_title)}</div>
                            <div class="hitem-chap">–ì–ª–∞–≤–∞ ${esc(String(r.chapter_number))}</div>
                        </div>
                        <div class="hitem-date">${fmtDate(r.last_read)}</div>
                    </a>`).join('') + '</div>';
            }).catch(() => { document.getElementById('historyContent').innerHTML = emptyState('‚ö†Ô∏è', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'); });
    }

    // Subscriptions
    function fetchSubs() {
        fetch('/api/user/subscriptions?uid=' + PROFILE_USER_ID)
            .then(r => r.json())
            .then(rows => {
                const el = document.getElementById('subsContent');
                if (!rows.length) { el.innerHTML = emptyState('üîî', '–ù–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫', '–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –ª—é–±–∏–º—ã–µ –º–∞–Ω–≥–∏ –Ω–∞ –∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö'); return; }
                el.innerHTML = '<div class="manga-grid-lib">' + rows.map(m => `
                    <div class="mcard" onclick="location.href='/manga/${esc(m.manga_slug)}'">
                        <img src="${esc(m.cover_url)}" class="mcard-img" onerror="this.src='https://via.placeholder.com/130x195/1a1a1a/667eea'" loading="lazy">
                        <div class="mcard-info">
                            <div class="mcard-title">${esc(m.manga_title)}</div>
                            <div class="mcard-meta">${typeRu(m.manga_type)}</div>
                        </div>
                    </div>`).join('') + '</div>';
            }).catch(() => { document.getElementById('subsContent').innerHTML = emptyState('‚ö†Ô∏è', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'); });
    }

    // Collections
    let editingCollId = null;
    function fetchColls() {
        fetch('/api/user/collections?uid=' + PROFILE_USER_ID)
            .then(r => r.json())
            .then(renderColls)
            .catch(() => { document.getElementById('collsContent').innerHTML = emptyState('‚ö†Ô∏è', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'); });
    }

    function renderColls(colls) {
        const el = document.getElementById('collsContent');
        if (!colls.length) { el.innerHTML = emptyState('üìÅ', '–ù–µ—Ç –∫–æ–ª–ª–µ–∫—Ü–∏–π', IS_OWN ? '–°–æ–∑–¥–∞–π –ø–µ—Ä–≤—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é!' : '–ü–æ–∫–∞ –Ω–µ—Ç –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π'); return; }
        const emojis = ['üìö','üéå','‚öîÔ∏è','üå∏','üî•','üëæ','üí´','üé≠'];
        el.innerHTML = '<div class="coll-grid">' + colls.map((c, i) => `
            <div class="coll-card" onclick="openColl(${c.id}, ${JSON.stringify(c.name)})">
                <div class="coll-cover">${emojis[i % emojis.length]}</div>
                <div class="coll-body">
                    <div class="coll-name">${esc(c.name)}</div>
                    <div class="coll-desc">${esc(c.description || '‚Äî')}</div>
                    <div class="coll-meta">
                        <span class="coll-count">üìñ ${c.items_count} –º–∞–Ω–≥</span>
                        ${IS_OWN ? `<div class="coll-actions" onclick="event.stopPropagation()">
                            <button class="coll-btn" onclick="editColl(${c.id},${JSON.stringify(c.name)},${JSON.stringify(c.description||'')},${c.is_public})" title="–ò–∑–º–µ–Ω–∏—Ç—å">‚úèÔ∏è</button>
                            <button class="coll-btn del" onclick="deleteColl(${c.id})" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>
                        </div>` : ''}
                    </div>
                </div>
            </div>`).join('') + '</div>';
    }

    function openColl(id, name) {
        const el = document.getElementById('collsContent');
        el.innerHTML = `<div class="coll-detail-back" onclick="backToColls()">‚Üê –ù–∞–∑–∞–¥ –∫ –∫–æ–ª–ª–µ–∫—Ü–∏—è–º</div>
            <div style="font-size:18px;font-weight:800;margin-bottom:16px">${esc(name)}</div>
            <div id="collItemsContent"><div class="loading-spin"><div class="spin"></div></div></div>`;
        fetch(`/api/collections/${id}/items`)
            .then(r => r.json())
            .then(items => {
                const box = document.getElementById('collItemsContent');
                if (!items.length) { box.innerHTML = emptyState('üìñ', '–ö–æ–ª–ª–µ–∫—Ü–∏—è –ø—É—Å—Ç–∞', IS_OWN ? '–î–æ–±–∞–≤–ª—è–π –º–∞–Ω–≥—É —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü –º–∞–Ω–≥–∏' : ''); return; }
                box.innerHTML = '<div class="manga-grid-lib">' + items.map(m => `
                    <div class="mcard" onclick="location.href='/manga/${esc(m.manga_slug)}'">
                        ${IS_OWN ? `<button class="mcard-remove" onclick="event.stopPropagation();removeManga(${id},'${esc(m.manga_id)}',this.closest('.mcard'))" title="–£–±—Ä–∞—Ç—å">‚úï</button>` : ''}
                        <img src="${esc(m.cover_url)}" class="mcard-img" onerror="this.src='https://via.placeholder.com/130x195/1a1a1a/667eea'" loading="lazy">
                        <div class="mcard-info">
                            <div class="mcard-title">${esc(m.manga_title)}</div>
                            <div class="mcard-meta">${typeRu(m.manga_type)}</div>
                        </div>
                    </div>`).join('') + '</div>';
            });
    }

    function backToColls() { libLoaded['collections'] = false; fetchColls(); }

    function editColl(id, name, desc, isPublic) {
        editingCollId = id;
        document.getElementById('collModalTitle').textContent = '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é';
        document.getElementById('collName').value = name;
        document.getElementById('collDesc').value = desc;
        document.getElementById('collPublic').checked = !!isPublic;
        document.getElementById('collSaveBtn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        openModal('collModal');
    }

    async function deleteColl(id) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é?')) return;
        const r = await fetch(`/api/collections/${id}`, { method: 'DELETE' });
        if (r.ok) { toast('–ö–æ–ª–ª–µ–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞', 'success'); libLoaded['collections'] = false; fetchColls(); }
        else toast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
    }

    async function removeManga(collId, mangaId, cardEl) {
        const r = await fetch(`/api/collections/${collId}/manga/${mangaId}`, { method: 'DELETE' });
        if (r.ok) { cardEl.remove(); toast('–£–±—Ä–∞–Ω–æ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏', 'success'); }
        else toast('–û—à–∏–±–∫–∞', 'error');
    }

    async function saveCollection() {
        const name = document.getElementById('collName').value.trim();
        if (!name) { toast('–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'error'); return; }
        const body = { name, description: document.getElementById('collDesc').value.trim(), is_public: document.getElementById('collPublic').checked };
        const url = editingCollId ? `/api/collections/${editingCollId}` : '/api/collections';
        const method = editingCollId ? 'PUT' : 'POST';
        const r = await fetch(url, { method, headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const d = await r.json();
        if (d.success || d.id) {
            toast(editingCollId ? '–û–±–Ω–æ–≤–ª–µ–Ω–æ' : '–ö–æ–ª–ª–µ–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞', 'success');
            closeModal('collModal');
            editingCollId = null;
            document.getElementById('collName').value = '';
            document.getElementById('collDesc').value = '';
            document.getElementById('collModalTitle').textContent = 'üìÅ –ù–æ–≤–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è';
            document.getElementById('collSaveBtn').textContent = '–°–æ–∑–¥–∞—Ç—å';
            libLoaded['collections'] = false;
            fetchColls();
        } else toast(d.error || '–û—à–∏–±–∫–∞', 'error');
    }

    // Bio / Name
    const bioInput = document.getElementById('bioInput');
    const bioCount = document.getElementById('bioCount');
    if (bioInput) {
        bioCount.textContent = bioInput.value.length;
        bioInput.addEventListener('input', () => { bioCount.textContent = bioInput.value.length; });
    }

    async function saveProfile() {
        const bio = bioInput ? bioInput.value.trim() : '';
        const nameEl = document.getElementById('nameInput');
        const custom_name = nameEl ? nameEl.value.trim() : '';
        const r = await fetch('/api/profile/update', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({bio, custom_name}) });
        const d = await r.json();
        if (d.success) {
            document.getElementById('heroBio').textContent = bio || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
            const nameDisplay = document.querySelector('.profile-name');
            if (nameDisplay && custom_name) nameDisplay.textContent = custom_name;
            toast('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
            closeModal('editProfileModal');
        } else toast(d.error || '–û—à–∏–±–∫–∞', 'error');
    }

    // Edit profile modal tabs
    function switchEditTab(tab) {
        document.querySelectorAll('.edit-tab').forEach(b => b.classList.toggle('active', b.dataset.etab === tab));
        document.querySelectorAll('.edit-pane').forEach(p => p.classList.toggle('active', p.id === 'epane-' + tab));
        if (tab === 'avatar') renderShopGrid('avatarItemsGrid', 'avatar');
        if (tab === 'frame') renderShopGrid('frameItemsGrid', 'frame');
        if (tab === 'bg') renderShopGrid('bgItemsGrid', 'background');
    }

    function openEditModal(tab) {
        openModal('editProfileModal');
        switchEditTab(tab || 'main');
    }

    function renderShopGrid(gridId, type) {
        const el = document.getElementById(gridId);
        if (!el) return;
        const items = OWNED_ITEMS.filter(i => i.type === type);
        if (!items.length) { el.innerHTML = '<div class="sitem-empty">–ù–µ—Ç –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞.<br>–ó–∞–≥–ª—è–Ω–∏ –≤ <a href="/shop" style="color:#667eea">–ú–∞–≥–∞–∑–∏–Ω</a>!</div>'; return; }
        el.innerHTML = items.map(item => {
            let preview = '';
            if (type === 'avatar') {
                const src = item.preview_url || '';
                preview = src
                    ? `<img src="${esc(src)}" alt="${esc(item.name)}">`
                    : `<div style="width:66px;height:66px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;font-size:1.6rem">üë§</div>`;
            } else if (item.preview_url) {
                preview = `<img src="${esc(item.preview_url)}" style="width:100%;height:100%;object-fit:cover">`;
            } else if (type === 'frame' && item.css_value) {
                preview = `<div style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);border:3px solid ${esc(item.css_value)};box-shadow:0 0 10px ${esc(item.css_value)}55"></div>`;
            } else if (type === 'background' && item.css_value) {
                preview = `<div style="width:100%;height:100%;${esc(item.css_value)}"></div>`;
            } else {
                preview = 'üé®';
            }
            const eq = item.is_equipped ? 1 : 0;
            return `<div class="sitem${eq?' equipped':''}" onclick="equipItem(${item.id},'${type}',this)">
                <div class="sitem-preview">${preview}${eq?'<div class="sitem-badge">‚úì</div>':''}</div>
                <div class="sitem-name">${esc(item.name)}</div>
            </div>`;
        }).join('');
    }

    async function equipItem(itemId, type, cardEl) {
        const r = await fetch(`/api/profile/equip/${itemId}`, {method:'POST'});
        const d = await r.json();
        if (!r.ok) { toast(d.error || '–û—à–∏–±–∫–∞', 'error'); return; }
        // Update UI
        const gridId = type === 'avatar' ? 'avatarItemsGrid' : type === 'frame' ? 'frameItemsGrid' : 'bgItemsGrid';
        document.querySelectorAll(`#${gridId} .sitem`).forEach(c => {
            c.classList.remove('equipped');
            const b = c.querySelector('.sitem-badge');
            if (b) b.remove();
        });
        if (d.equipped) {
            cardEl.classList.add('equipped');
            const prev = cardEl.querySelector('.sitem-preview');
            if (prev && !prev.querySelector('.sitem-badge')) {
                const badge = document.createElement('div');
                badge.className = 'sitem-badge'; badge.textContent = '‚úì';
                prev.appendChild(badge);
            }
            // Update OWNED_ITEMS
            OWNED_ITEMS.forEach(i => { if (i.type === type) i.is_equipped = (i.id === itemId ? 1 : 0); });
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ—Ñ–∏–ª—è —Å—Ä–∞–∑—É
            if (type === 'avatar') {
                const item = OWNED_ITEMS.find(i => i.id === itemId);
                const avatarEl = document.getElementById('avatarEl');
                if (avatarEl && item && item.preview_url) {
                    avatarEl.innerHTML = `<img src="${esc(item.preview_url)}" alt="Avatar">`;
                }
            }
        } else {
            cardEl.classList.remove('equipped');
            OWNED_ITEMS.forEach(i => { if (i.id === itemId) i.is_equipped = 0; });
        }
        toast(d.equipped ? '–ù–∞–¥–µ—Ç–æ!' : '–°–Ω—è—Ç–æ', 'success');
    }

    // File preview
    function previewFile(input, previewId, shape) {
        const file = input.files[0]; if (!file) return;
        const img = document.getElementById(previewId);
        img.style.display = 'block';
        img.style.borderRadius = shape === 'circle' ? '50%' : '10px';
        const reader = new FileReader();
        reader.onload = e => img.src = e.target.result;
        reader.readAsDataURL(file);
    }

    async function uploadAvatar() {
        const input = document.getElementById('avatarFile');
        if (!input.files[0]) { toast('–í—ã–±–µ—Ä–∏ —Ñ–∞–π–ª', 'error'); return; }
        const fd = new FormData(); fd.append('file', input.files[0]);
        const r = await fetch('/upload/avatar', { method:'POST', body:fd });
        const d = await r.json();
        if (d.avatar_url) {
            document.getElementById('avatarEl').innerHTML = `<img src="${d.avatar_url}" alt="Avatar">`;
            toast('–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω!', 'success');
        } else toast(d.error || '–û—à–∏–±–∫–∞', 'error');
    }

    async function uploadBg() {
        const input = document.getElementById('bgFile');
        if (!input.files[0]) { toast('–í—ã–±–µ—Ä–∏ —Ñ–∞–π–ª', 'error'); return; }
        const fd = new FormData(); fd.append('file', input.files[0]);
        const r = await fetch('/upload/background', { method:'POST', body:fd });
        const d = await r.json();
        if (d.background_url) {
            const el = document.getElementById('heroBgImg');
            el.style.backgroundImage = `url('${d.background_url}')`;
            toast('–§–æ–Ω –æ–±–Ω–æ–≤–ª—ë–Ω!', 'success');
        } else toast(d.error || '–û—à–∏–±–∫–∞', 'error');
    }

    // Modals
    function openModal(id) { document.getElementById(id).classList.add('open'); document.body.style.overflow = 'hidden'; }
    function closeModal(id) { document.getElementById(id).classList.remove('open'); document.body.style.overflow = ''; }
    document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('click', e => { if (e.target === m) closeModal(m.id); }));
    document.addEventListener('keydown', e => { if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.open').forEach(m => closeModal(m.id)); });

    // Toast
    let toastTimer;
    function toast(msg, type='') {
        const el = document.getElementById('toast');
        el.textContent = msg; el.className = 'toast show ' + type;
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => el.classList.remove('show'), 3000);
    }

    // Helpers
    function esc(s) { return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
    function fmtDate(s) {
        if (!s) return '';
        const d = new Date(s), now = new Date(), diff = (now - d) / 1000;
        if (diff < 3600) return Math.floor(diff/60) + ' –º–∏–Ω –Ω–∞–∑–∞–¥';
        if (diff < 86400) return Math.floor(diff/3600) + ' —á –Ω–∞–∑–∞–¥';
        if (diff < 604800) return Math.floor(diff/86400) + ' –¥ –Ω–∞–∑–∞–¥';
        return d.toLocaleDateString('ru-RU', {day:'numeric',month:'short'});
    }
    function typeRu(t) { return {MANGA:'–ú–∞–Ω–≥–∞',MANHWA:'–ú–∞–Ω—Ö–≤–∞',MANHUA:'–ú–∞–Ω—å—Ö—É–∞',NOVEL:'–ù–æ–≤–µ–ª–ª–∞'}[t] || t || ''; }
    function emptyState(icon, title, sub='') {
        return `<div class="empty-state"><div class="empty-icon">${icon}</div><div style="font-weight:700;margin-bottom:4px">${title}</div>${sub?`<div style="font-size:13px">${sub}</div>`:''}</div>`;
    }
</script>
</body>
</html>
