<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0"/>
  <meta name="theme-color" content="#667eea"/>
  <title>ÐœÐ°Ð³Ð°Ð·Ð¸Ð½ â€” BubbleManga</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    :root {
      --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --accent: #667eea;
      --bg: #0a0a0a; --card2: #141414;
      --border: rgba(255,255,255,.06);
      --text: #ffffff; --text-2: #b8b8b8; --text-3: #71717a;
    }
    html,body { font-family:'Poppins',-apple-system,BlinkMacSystemFont,sans-serif; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; line-height:1.6; overflow-x:hidden; }
    a { color:inherit; }

    /* â”€â”€ Ð¨Ð°Ð¿ÐºÐ° â”€â”€ */
    .site-header { position:fixed; top:0; left:0; right:0; z-index:1000; background:rgba(10,10,10,.97); backdrop-filter:blur(20px); border-bottom:1px solid rgba(255,255,255,.08); }
    .site-header-inner { max-width:1400px; margin:0 auto; padding:14px 20px; display:flex; align-items:center; justify-content:space-between; gap:16px; }
    .site-logo { font-size:20px; font-weight:800; text-decoration:none; letter-spacing:-.5px; background:var(--primary); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; display:flex; align-items:center; gap:7px; }
    .site-nav { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .nav-btn { padding:8px 16px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); border-radius:50px; color:#fff; text-decoration:none; font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; white-space:nowrap; transition:background .2s,transform .15s; display:inline-flex; align-items:center; gap:5px; }
    .nav-btn:active { transform:scale(.95); }
    .nav-btn.active { background:var(--primary); border-color:transparent; }
    @media(min-width:1024px){ .nav-btn:hover { background:rgba(255,255,255,.09); } .nav-btn.active:hover { opacity:.88; } }

    .page-wrap { padding-top:0; }

    /* â”€â”€ Hero â”€â”€ */
    .shop-hero { text-align:center; padding:1.8rem 1rem 1.4rem; background:linear-gradient(135deg,#08081a 0%,#0f0c2a 50%,#10091e 100%); border-bottom:1px solid var(--border); }
    .shop-hero h1 { font-size:2.1rem; font-weight:800; background:var(--primary); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; margin-bottom:.35rem; }
    .shop-hero p { color:var(--text-2); font-size:.88rem; }
    .hero-badges { display:flex; flex-wrap:wrap; justify-content:center; align-items:center; gap:.5rem; margin-top:.75rem; }
    .balance-chip { display:inline-flex; align-items:center; gap:.4rem; background:rgba(102,126,234,.12); border:1px solid rgba(102,126,234,.3); border-radius:20px; padding:.33rem .95rem; font-weight:700; font-size:.9rem; color:#a5b4fc; }
    .premium-banner { display:inline-flex; align-items:center; gap:.5rem; background:linear-gradient(135deg,rgba(245,158,11,.15),rgba(217,119,6,.1)); border:1px solid rgba(245,158,11,.4); border-radius:20px; padding:.33rem .95rem; font-weight:700; font-size:.82rem; color:#fcd34d; }

    /* â”€â”€ Ð’ÐºÐ»Ð°Ð´ÐºÐ¸ â”€â”€ */
    .shop-tabs-wrap { position:sticky; top:160px; z-index:100; background:rgba(10,10,10,.96); backdrop-filter:blur(16px); border-bottom:1px solid var(--border); }
    @media(max-width:700px){ .shop-tabs-wrap { top:100px; } }
    .shop-tabs { display:flex; gap:5px; padding:10px 14px; overflow-x:auto; max-width:960px; margin:0 auto; scrollbar-width:none; justify-content:center; }
    .shop-tabs::-webkit-scrollbar { display:none; }
    .shop-tab { flex-shrink:0; padding:7px 15px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); border-radius:50px; color:var(--text-2); font-size:12.5px; font-weight:600; cursor:pointer; transition:all .2s; font-family:inherit; white-space:nowrap; }
    .shop-tab:hover { background:rgba(255,255,255,.1); color:#fff; }
    .shop-tab.active { background:linear-gradient(135deg,#667eea,#764ba2); border-color:transparent; color:#fff; }

    /* â”€â”€ ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ â”€â”€ */
    .shop-container { max-width:960px; margin:0 auto; padding:1.4rem 1rem 5rem; }
    .section-head { font-size:.92rem; font-weight:700; color:#d4d4d8; margin:1.5rem 0 .75rem; display:flex; align-items:center; gap:.4rem; }

    /* â”€â”€ Ð¡ÐµÑ‚ÐºÐ¸ â”€â”€ */
    .items-grid        { display:grid; grid-template-columns:repeat(auto-fill,minmax(175px,1fr)); gap:.9rem; }
    .items-grid-avatar { display:grid; grid-template-columns:repeat(auto-fill,minmax(145px,1fr)); gap:.9rem; }

    /* â”€â”€ ÐšÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ° â”€â”€ */
    .item-card { background:var(--card2); border:1px solid var(--border); border-radius:16px; overflow:hidden; transition:border-color .2s,transform .15s,box-shadow .2s; display:flex; flex-direction:column; position:relative; }
    .item-card:hover { border-color:rgba(102,126,234,.3); transform:translateY(-2px); }
    .item-card.owned  { border-color:rgba(102,126,234,.35); }
    .item-card.equipped { border-color:#667eea; box-shadow:0 0 0 1px #667eea,0 0 22px rgba(102,126,234,.22); }

    /* ÐŸÑ€ÐµÐ²ÑŒÑŽ â€” Ð°Ð²Ð°Ñ‚Ð°Ñ€ */
    .item-preview-avatar { height:145px; display:flex; align-items:center; justify-content:center; background:#0a0a0a; position:relative; overflow:hidden; }
    .avatar-circle { width:88px; height:88px; border-radius:50%; overflow:hidden; border:3px solid rgba(102,126,234,.45); box-shadow:0 0 20px rgba(102,126,234,.3); }
    .avatar-circle img { width:100%; height:100%; object-fit:cover; }
    .avatar-circle .av-placeholder { width:100%; height:100%; background:linear-gradient(135deg,#667eea,#764ba2); display:flex; align-items:center; justify-content:center; font-size:2rem; }

    /* ÐŸÑ€ÐµÐ²ÑŒÑŽ â€” Ñ€Ð°Ð¼ÐºÐ° */
    .item-preview-frame { height:130px; display:flex; align-items:center; justify-content:center; background:#0a0a0a; position:relative; overflow:hidden; }

    /* ÐŸÑ€ÐµÐ²ÑŒÑŽ â€” Ñ„Ð¾Ð½ */
    .item-preview-bg { height:115px; position:relative; overflow:hidden; background:#0a0a0a; }
    .item-preview-bg img { width:100%; height:100%; object-fit:cover; }
    .item-preview-bg .bg-overlay { position:absolute; inset:0; background:linear-gradient(to bottom,transparent 30%,rgba(0,0,0,.65)); }
    .item-preview-bg .bg-fake { position:absolute; bottom:9px; left:11px; display:flex; align-items:center; gap:6px; }
    .item-preview-bg .bf-av { width:26px; height:26px; border-radius:50%; background:linear-gradient(135deg,#667eea,#764ba2); border:2px solid rgba(255,255,255,.5); }
    .item-preview-bg .bf-name { font-size:9.5px; font-weight:700; color:rgba(255,255,255,.9); }

    /* ÐŸÑ€ÐµÐ²ÑŒÑŽ â€” generic */
    .item-preview { height:125px; display:flex; align-items:center; justify-content:center; font-size:3rem; background:#0d0d0d; position:relative; overflow:hidden; }
    .item-preview img { width:100%; height:100%; object-fit:cover; }

    /* Ð‘ÐµÐ¹Ð´Ð¶Ð¸ Ð½Ð° ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ°Ñ… */
    .anim-badge { position:absolute; top:.32rem; left:.32rem; background:linear-gradient(135deg,#f59e0b,#ef4444); border-radius:20px; padding:.1rem .42rem; font-size:.58rem; font-weight:800; color:#fff; letter-spacing:.3px; z-index:2; }
    .item-badge-equipped { position:absolute; top:.32rem; right:.32rem; background:#667eea; border-radius:20px; padding:.1rem .42rem; font-size:.58rem; font-weight:700; color:#fff; z-index:2; }
    .loan-badge { position:absolute; bottom:.32rem; left:.32rem; background:linear-gradient(135deg,#f59e0b,#d97706); border-radius:20px; padding:.1rem .42rem; font-size:.57rem; font-weight:700; color:#fff; z-index:2; }

    .item-body { padding:.7rem .8rem; flex:1; display:flex; flex-direction:column; gap:.28rem; }
    .item-name { font-weight:700; font-size:.83rem; color:#f4f4f5; line-height:1.3; }
    .item-desc { font-size:.7rem; color:var(--text-3); flex:1; line-height:1.5; }
    .item-footer { display:flex; align-items:center; justify-content:space-between; padding:.45rem .8rem .75rem; gap:6px; flex-wrap:wrap; row-gap:6px; }
    .item-price { display:flex; align-items:center; gap:.22rem; font-weight:700; font-size:.82rem; color:#a5b4fc; flex-shrink:1; min-width:0; }
    .item-price.free { color:#4ade80; }

    .btn-buy,.btn-equip,.btn-unequip,.btn-activate,.btn-buy-perm { padding:.3rem .75rem; border-radius:20px; font-size:.76rem; font-weight:700; cursor:pointer; border:none; transition:opacity .2s,transform .1s; font-family:inherit; flex-shrink:0; white-space:nowrap; }
    .btn-buy { background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; }
    .btn-buy:hover { opacity:.85; transform:scale(1.03); }
    .btn-buy:disabled { opacity:.4; cursor:not-allowed; transform:none; }
    .btn-equip { background:rgba(102,126,234,.12); color:#a5b4fc; border:1px solid rgba(102,126,234,.3); }
    .btn-equip:hover { background:rgba(102,126,234,.22); }
    .btn-unequip { background:rgba(240,93,176,.1); color:#f9a8d4; border:1px solid rgba(240,93,176,.2); }
    .btn-unequip:hover { background:rgba(240,93,176,.2); }
    .btn-activate { background:linear-gradient(135deg,#f59e0b,#d97706); color:#fff; }
    .btn-activate:hover { opacity:.85; transform:scale(1.03); }
    .btn-buy-perm { background:rgba(102,126,234,.12); color:#a5b4fc; border:1px solid rgba(102,126,234,.3); font-size:.68rem; }
    .btn-buy-perm:hover { background:rgba(102,126,234,.22); }
    .btn-buy-perm:disabled { opacity:.4; cursor:not-allowed; }
    .item-footer-col { display:flex; flex-direction:column; align-items:flex-end; gap:.28rem; }

    .empty-section { text-align:center; padding:3.5rem 1rem; color:var(--text-3); }
    .empty-section .eico { font-size:2.5rem; margin-bottom:.5rem; }
    .login-notice { text-align:center; padding:3rem 1rem; color:var(--text-3); }
    .login-notice a { color:var(--accent); text-decoration:none; }

    .toast { position:fixed; bottom:1.5rem; left:50%; transform:translateX(-50%) translateY(60px); background:#18181b; border:1px solid rgba(255,255,255,.1); border-radius:12px; padding:.65rem 1.3rem; font-size:.83rem; font-weight:600; color:#f4f4f5; transition:transform .3s; z-index:9999; pointer-events:none; font-family:'Poppins',sans-serif; }
    .toast.show { transform:translateX(-50%) translateY(0); }
    .toast.ok  { border-color:rgba(102,126,234,.4); color:#a5b4fc; }
    .toast.err { border-color:rgba(239,68,68,.4); color:#fca5a5; }

    /* â”€â”€ ÐŸÐ°ÐºÐµÑ‚Ñ‹ Ð¼Ð¾Ð½ÐµÑ‚ â”€â”€ */
    .coins-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:1rem; margin-top:1rem; }
    .coin-pkg-card { background:var(--card2); border:1px solid var(--border); border-radius:18px; padding:1.4rem 1.2rem; display:flex; flex-direction:column; align-items:center; gap:.7rem; transition:border-color .2s,transform .15s; text-align:center; }
    .coin-pkg-card:hover { border-color:rgba(250,204,21,.35); transform:translateY(-2px); }
    .coin-pkg-amount { font-size:2rem; font-weight:800; color:#fcd34d; line-height:1; }
    .coin-pkg-label { font-size:.78rem; color:var(--text-2); font-weight:600; }
    .coin-pkg-price { display:inline-flex; align-items:center; gap:.3rem; background:rgba(250,204,21,.1); border:1px solid rgba(250,204,21,.3); border-radius:20px; padding:.28rem .8rem; font-size:.82rem; font-weight:700; color:#fcd34d; }
    .btn-stars { background:linear-gradient(135deg,#fbbf24,#f59e0b); color:#000; padding:.5rem 1.1rem; border-radius:20px; font-size:.82rem; font-weight:700; cursor:pointer; border:none; font-family:inherit; transition:opacity .2s,transform .1s; width:100%; }
    .btn-stars:hover { opacity:.88; transform:scale(1.03); }
    .btn-stars:disabled { opacity:.45; cursor:not-allowed; transform:none; }

    /* â”€â”€ Premium ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ¸ â”€â”€ */
    .premium-grid { display:flex; flex-wrap:wrap; justify-content:center; gap:1rem; margin-top:1rem; }
    .premium-grid .prem-pkg-card { flex:0 1 240px; max-width:280px; }
    .prem-pkg-card { background:var(--card2); border:1px solid rgba(102,126,234,.2); border-radius:18px; padding:1.5rem 1.3rem; display:flex; flex-direction:column; gap:.75rem; transition:border-color .2s,transform .15s; position:relative; overflow:hidden; }
    .prem-pkg-card::before { content:''; position:absolute; inset:0; background:linear-gradient(135deg,rgba(102,126,234,.07),rgba(118,75,162,.04)); pointer-events:none; }
    .prem-pkg-card:hover { border-color:rgba(102,126,234,.5); transform:translateY(-2px); }
    .prem-pkg-card.popular { border-color:#667eea; box-shadow:0 0 0 1px rgba(102,126,234,.3),0 0 24px rgba(102,126,234,.12); }
    .prem-popular-badge { position:absolute; top:.6rem; right:.6rem; background:linear-gradient(135deg,#667eea,#764ba2); border-radius:20px; padding:.15rem .55rem; font-size:.6rem; font-weight:800; color:#fff; letter-spacing:.3px; }
    .prem-pkg-name { font-size:1.05rem; font-weight:800; color:#a5b4fc; }
    .prem-pkg-desc { font-size:.75rem; color:var(--text-3); }
    .prem-features { display:flex; flex-direction:column; gap:.32rem; }
    .prem-feature-main { background:linear-gradient(135deg,rgba(102,126,234,.18),rgba(118,75,162,.12)); border:1px solid rgba(102,126,234,.4); border-radius:10px; padding:.55rem .75rem; font-size:.8rem; font-weight:700; color:#c4b5fd; display:flex; align-items:center; gap:.5rem; margin-bottom:.2rem; }
    .prem-feature-main-icon { font-size:1rem; flex-shrink:0; }
    .prem-feature { font-size:.74rem; color:var(--text-2); display:flex; align-items:center; gap:.4rem; }
    .prem-feature::before { content:''; display:inline-block; width:5px; height:5px; border-radius:50%; background:#667eea; flex-shrink:0; }
    .prem-pkg-price { display:inline-flex; align-items:center; gap:.3rem; background:rgba(102,126,234,.1); border:1px solid rgba(102,126,234,.3); border-radius:20px; padding:.28rem .8rem; font-size:.82rem; font-weight:700; color:#a5b4fc; align-self:flex-start; }
    .btn-premium { background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; padding:.5rem 1.1rem; border-radius:20px; font-size:.82rem; font-weight:700; cursor:pointer; border:none; font-family:inherit; transition:opacity .2s,transform .1s; width:100%; }
    .btn-premium:hover { opacity:.88; transform:scale(1.03); }
    .btn-premium:disabled { opacity:.45; cursor:not-allowed; transform:none; }

    @media(max-width:600px){
      .premium-grid { flex-direction:column; align-items:center; gap:.75rem; }
      .premium-grid .prem-pkg-card { flex:none; width:100%; max-width:100%; }
      .prem-pkg-card { padding:1.1rem 1rem; gap:.6rem; border-radius:14px; }
      .prem-feature-main { font-size:.78rem; padding:.5rem .65rem; gap:.4rem; }
      .prem-feature-main-icon { font-size:.9rem; }
      .prem-feature { font-size:.72rem; }
      .prem-pkg-name { font-size:.95rem; }
    }

    /* â”€â”€ ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ â”€â”€ */
    .pay-overlay { position:fixed; inset:0; background:rgba(0,0,0,.72); z-index:5000; display:flex; align-items:center; justify-content:center; padding:1rem; backdrop-filter:blur(8px); animation:pmFadeIn .15s; }
    @keyframes pmFadeIn { from{opacity:0} to{opacity:1} }
    .pay-modal { background:#141414; border:1px solid rgba(255,255,255,.1); border-radius:22px; padding:1.6rem 1.4rem 1.4rem; width:100%; max-width:380px; animation:pmSlide .2s; }
    @keyframes pmSlide { from{transform:translateY(18px);opacity:0} to{transform:none;opacity:1} }
    .pay-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:1.1rem; }
    .pay-pkg-info { display:flex; align-items:baseline; gap:.35rem; }
    .pay-pkg-coins { font-size:1.5rem; font-weight:800; color:#fcd34d; }
    .pay-pkg-sub { font-size:.82rem; color:var(--text-2); font-weight:600; }
    .pay-close { background:rgba(255,255,255,.07); border:none; color:#888; width:32px; height:32px; border-radius:50%; cursor:pointer; font-size:1rem; line-height:1; transition:background .15s; }
    .pay-close:hover { background:rgba(255,255,255,.14); }
    .pay-subtitle { font-size:.82rem; color:var(--text-3); margin-bottom:.9rem; font-weight:500; }
    .pay-methods { display:flex; flex-direction:column; gap:.55rem; }
    .pay-btn { display:flex; align-items:center; gap:.9rem; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:.85rem 1rem; cursor:pointer; transition:background .15s,border-color .15s,transform .1s; text-align:left; width:100%; font-family:inherit; }
    .pay-btn:hover:not(:disabled) { background:rgba(255,255,255,.09); border-color:rgba(102,126,234,.4); transform:translateY(-1px); }
    .pay-btn:disabled { opacity:.45; cursor:wait; }
    .pay-btn-icon { font-size:1.6rem; width:2.2rem; text-align:center; flex-shrink:0; }
    .pay-btn-info { flex:1; }
    .pay-btn-name { font-size:.86rem; font-weight:700; color:#f4f4f5; }
    .pay-btn-price { font-size:.73rem; color:var(--text-3); margin-top:.1rem; }
    .pay-btn-arrow { color:var(--text-3); font-size:.95rem; flex-shrink:0; transition:transform .15s; }
    .pay-btn:hover:not(:disabled) .pay-btn-arrow { transform:translateX(3px); color:#a5b4fc; }
    .pay-note { font-size:.72rem; color:var(--text-3); text-align:center; margin-top:.85rem; line-height:1.5; }

    @media(max-width:600px){
      .shop-hero { padding:1.3rem .75rem 1.1rem; }
      .shop-hero h1 { font-size:1.5rem; margin-bottom:.25rem; }
      .shop-hero p { font-size:.8rem; }
      .hero-badges { gap:.4rem; margin-top:.6rem; }
      .balance-chip { font-size:.82rem; padding:.28rem .8rem; }
      .premium-banner { font-size:.75rem; padding:.28rem .8rem; }
      .items-grid        { grid-template-columns:repeat(2,1fr); gap:.55rem; }
      .items-grid-avatar { grid-template-columns:repeat(2,1fr); gap:.55rem; }
      .coins-grid        { grid-template-columns:repeat(2,1fr); gap:.55rem; }
      .shop-container    { padding-left:10px; padding-right:10px; }
      /* Card previews â€” shorter for 2-column layout */
      .item-preview-avatar { height:110px; }
      .avatar-circle { width:68px; height:68px; }
      .item-preview-frame { height:100px; }
      .item-preview-bg { height:88px; }
      .item-preview { height:96px; font-size:2.2rem; }
      /* Card body/footer â€” tighter */
      .item-body { padding:.5rem .6rem; gap:.2rem; }
      .item-name { font-size:.78rem; }
      .item-desc { font-size:.67rem; }
      .item-footer { padding:.35rem .6rem .55rem; gap:4px; flex-wrap:nowrap; }
      .item-price { font-size:.75rem; }
      .btn-buy,.btn-equip,.btn-unequip,.btn-activate { padding:.26rem .55rem; font-size:.7rem; }
      .btn-buy-perm { padding:.22rem .45rem; font-size:.64rem; }
      /* Coin packages â€” compact */
      .coin-pkg-card { padding:.9rem .75rem; gap:.5rem; border-radius:14px; }
      .coin-pkg-amount { font-size:1.5rem; }
      .coin-pkg-label { font-size:.72rem; }
      .coin-pkg-price { font-size:.75rem; padding:.22rem .65rem; }
      .btn-stars { font-size:.76rem; padding:.42rem .8rem; }
    }
  </style>
</head>
<body>

{% set g_active = 'shop' %}{% include 'header.html' %}

<div class="page-wrap">
  <div id="shop-root"></div>
</div>
<div class="toast"></div>

<script type="importmap">
{"imports":{"react":"https://esm.sh/react@18","react-dom/client":"https://esm.sh/react-dom@18/client"}}
</script>
<script type="module">
import React from 'react';
import {createRoot} from 'react-dom/client';
const {createElement:h,Fragment,useState,useCallback,useMemo,useEffect} = React;

const ALL_ITEMS       = {{ items | tojson }};
const OWNED_IDS       = new Set({{ owned_ids | tojson }});
const EQUIPPED        = {{ equipped | tojson }};
const USER_ID         = {{ user_id | tojson }};
const INIT_COINS      = {{ coins | tojson }};
const IS_PREMIUM      = {{ is_premium | tojson }};
const PREMIUM_EXPIRES = {{ premium_expires_at | tojson }};
const LOANED_IDS      = new Set({{ loaned_ids | tojson }});

const TABS = [
  {id:'all',        label:' Ð’ÑÐµ'},
  {id:'premium',    label:'ÐŸÑ€ÐµÐ¼Ð¸ÑƒÐ¼'},
  {id:'buy',        label:'Ð¨Ð°Ñ€Ð¸ÐºÐ¸'},
  {id:'avatar',     label:' ÐÐ²Ð°Ñ‚Ð°Ñ€Ñ‹'},
  {id:'frame',      label:'Ð Ð°Ð¼ÐºÐ¸'},
  {id:'background', label:'Ð¤Ð¾Ð½Ñ‹'},
  {id:'badge',      label:'Ð—Ð½Ð°Ñ‡ÐºÐ¸'},
  {id:'other',      label:'Ð¡Ð»Ð¾Ñ‚Ñ‹'},
];
const OTHER_TYPES = new Set(['avatar_slot','bg_slot']);

const GROUP_ORDER  = ['avatar','frame','background','badge','avatar_slot','bg_slot'];
const GROUP_LABELS = {
  avatar:     ' ÐÐ²Ð°Ñ‚Ð°Ñ€Ñ‹',
  frame:      'Ð Ð°Ð¼ÐºÐ¸ Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°',
  background: 'Ð¤Ð¾Ð½Ñ‹ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ',
  badge:      'Ð—Ð½Ð°Ñ‡ÐºÐ¸',
  avatar_slot:'Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°',
  bg_slot:    'Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ„Ð¾Ð½Ð°',
};

function toast(msg,type='ok'){
  const el=document.querySelector('.toast');
  if(!el)return;
  el.textContent=msg; el.className=`toast ${type} show`;
  setTimeout(()=>{el.className=`toast ${type}`;},2500);
}

// â”€â”€ ÐŸÑ€ÐµÐ²ÑŒÑŽ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PreviewAvatar({item}){
  return h('div',{className:'item-preview-avatar'},
    item.is_animated && h('div',{className:'anim-badge'},'GIF'),
    h('div',{className:'avatar-circle'},
      item.preview_url
        ? h('img',{src:item.preview_url,alt:'',loading:'lazy'})
        : h('div',{className:'av-placeholder'},'')
    )
  );
}

function PreviewFrame({item}){
  if(item.preview_url)
    return h('div',{className:'item-preview-frame'},h('img',{src:item.preview_url,alt:'',style:{width:'100%',height:'100%',objectFit:'cover'}}));
  const s = item.css_value
    ? {width:72,height:72,borderRadius:'50%',background:'linear-gradient(135deg,#667eea,#764ba2)',border:`4px solid ${item.css_value}`,boxShadow:`0 0 16px ${item.css_value}99`}
    : {width:72,height:72,borderRadius:'50%',background:'linear-gradient(135deg,#667eea,#764ba2)'};
  return h('div',{className:'item-preview-frame'},h('div',{style:s}));
}

function PreviewBackground({item}){
  if(item.preview_url)
    return h('div',{className:'item-preview-bg'},
      item.is_animated && h('div',{className:'anim-badge'},'GIF'),
      h('img',{src:item.preview_url,alt:'',loading:'lazy'}),
      h('div',{className:'bg-overlay'}),
      h('div',{className:'bg-fake'},
        h('div',{className:'bf-av'}),
        h('div',{className:'bf-name'},'ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ')
      )
    );
  if(item.css_value)
    return h('div',{className:'item-preview-bg',style:{background:item.css_value}},
      h('div',{className:'bg-overlay'}),
      h('div',{className:'bg-fake'},
        h('div',{className:'bf-av'}),
        h('div',{className:'bf-name'},'ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ')
      )
    );
  return h('div',{className:'item-preview',style:{height:115}},'ðŸŒ„');
}

function ItemPreview({item}){
  if(item.type==='avatar')     return h(PreviewAvatar,{item});
  if(item.type==='frame')      return h(PreviewFrame,{item});
  if(item.type==='background') return h(PreviewBackground,{item});
  if(item.type==='badge'&&item.css_value)
    return h('div',{className:'item-preview'},h('span',{style:{fontSize:'2.8rem'}},item.css_value));
  if(item.preview_url)
    return h('div',{className:'item-preview'},h('img',{src:item.preview_url,alt:''}));
  const emo={avatar_slot:'ðŸ“¤',bg_slot:'ðŸ–¼ï¸'};
  return h('div',{className:'item-preview'},h('span',{style:{fontSize:'2.5rem'}},emo[item.type]||'ðŸ“¦'));
}

// â”€â”€ ÐšÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ItemCard({item,coins,eqMap,onBuy,onEquip,onActivate}){
  const owned    = OWNED_IDS.has(item.id);
  const loaned   = LOANED_IDS.has(item.id);
  const equipped = !!(eqMap[item.id]);
  const canAfford = coins >= item.price;

  let cls = 'item-card';
  if(equipped) cls+=' equipped';
  else if(owned) cls+=' owned';

  let btns;
  if(owned&&!loaned){
    btns = h('button',{className:equipped?'btn-unequip':'btn-equip',onClick:()=>onEquip(item)},equipped?'Ð¡Ð½ÑÑ‚ÑŒ':'ÐÐ°Ð´ÐµÑ‚ÑŒ');
  } else if(loaned){
    btns = h('div',{className:'item-footer-col'},
      h('button',{className:equipped?'btn-unequip':'btn-equip',onClick:()=>onEquip(item)},equipped?'Ð¡Ð½ÑÑ‚ÑŒ':'ÐÐ°Ð´ÐµÑ‚ÑŒ'),
      h('button',{className:'btn-buy-perm',disabled:!canAfford,title:canAfford?'ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ Ð½Ð°Ð²ÑÐµÐ³Ð´Ð°':`ÐÑƒÐ¶Ð½Ð¾ ${item.price} ÑˆÐ°Ñ€Ð¸ÐºÐ¾Ð²`,onClick:()=>onBuy(item)},'ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ')
    );
  } else if(USER_ID&&IS_PREMIUM){
    btns = h('div',{className:'item-footer-col'},
      h('button',{className:'btn-activate',onClick:()=>onActivate(item)},'ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ'),
      h('button',{className:'btn-buy-perm',disabled:!canAfford,title:canAfford?'ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ Ð½Ð°Ð²ÑÐµÐ³Ð´Ð°':`ÐÑƒÐ¶Ð½Ð¾ ${item.price} ÑˆÐ°Ñ€Ð¸ÐºÐ¾Ð²`,onClick:()=>onBuy(item)},'ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ')
    );
  } else if(USER_ID){
    btns = h('button',{className:'btn-buy',disabled:!canAfford,title:canAfford?'':`ÐÑƒÐ¶Ð½Ð¾ ${item.price} ÑˆÐ°Ñ€Ð¸ÐºÐ¾Ð²`,onClick:()=>onBuy(item)},'ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ');
  } else {
    btns = h('button',{className:'btn-buy',disabled:true},'Ð’Ð¾Ð¹Ñ‚Ð¸');
  }

  return h('div',{className:cls},
    equipped && h('div',{className:'item-badge-equipped'},'âœ“ ÐÐ°Ð´ÐµÑ‚Ð¾'),
    loaned   && h('div',{className:'loan-badge'},' Premium'),
    h(ItemPreview,{item}),
    h('div',{className:'item-body'},
      h('div',{className:'item-name'},item.name),
      item.description && h('div',{className:'item-desc'},item.description)
    ),
    h('div',{className:'item-footer'},
      h('div',{className:`item-price${item.price===0?' free':''}`},
        item.price===0
          ? 'Ð‘ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾'
          : h(Fragment,null,
              h('img',{src:'/static/bubbles.svg',style:{width:'1em',height:'1em',verticalAlign:'-0.15em',marginRight:'3px'},alt:''}),
              item.price.toLocaleString()
            )
      ),
      btns
    )
  );
}

// â”€â”€ ÐŸÐ¾ÐºÑƒÐ¿ÐºÐ° Ð¼Ð¾Ð½ÐµÑ‚/Premium â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BOT_BUY_URL = 'https://t.me/hookah_p_bot?start=buy';

const COIN_PACKAGES_STATIC = [
  {id:'coins_100',  coins:100,  stars:15,  rub:129,   usd:'1.49'},
  {id:'coins_300',  coins:300,  stars:40,  rub:329,   usd:'3.99'},
  {id:'coins_700',  coins:700,  stars:85,  rub:699,   usd:'7.99'},
  {id:'coins_1500', coins:1500, stars:175, rub:1399,  usd:'15.99'},
];

const PREMIUM_PACKAGES_STATIC = [
  {id:'premium_1m',  days:30,  name:'1 Ð¼ÐµÑÑÑ†',  rub:199,  usd:'2.49'},
  {id:'premium_3m',  days:90,  name:'3 Ð¼ÐµÑÑÑ†Ð°', rub:499,  usd:'5.99', popular:true},
  {id:'premium_12m', days:365, name:'1 Ð³Ð¾Ð´',    rub:1499, usd:'17.99'},
];

const PREMIUM_MAIN_FEATURE = 'ÐÐ¾Ð²Ñ‹Ðµ Ð³Ð»Ð°Ð²Ñ‹ Ð² Telegram â€” ÑÑ€Ð°Ð·Ñƒ Ð¿Ñ€Ð¸ Ð²Ñ‹Ñ…Ð¾Ð´Ðµ';
const PREMIUM_FEATURES = [
  'ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¾Ð² Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð° Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾',
  'Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº ÑÐºÑÐºÐ»ÑŽÐ·Ð¸Ð²Ð½Ñ‹Ð¼ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð°Ð¼',
  'Ð—Ð½Ð°Ñ‡Ð¾Ðº Premium Ð½Ð° Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ðµ',
  'ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ Ð² Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐµ',
];

// â”€â”€ Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¼Ð¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// apiEndpoint: '/api/shop/create-payment' | '/api/shop/create-premium-payment'
// title/sub: Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº Ð¸ Ð¿Ð¾Ð´Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº
// showStars: Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð»Ð¸ Telegram Stars
function PayModal({pkg, onClose, apiEndpoint, title, sub, note, showStars}){
  const [busy, setBusy] = useState(null);

  const pay = useCallback(async (method)=>{
    if(method === 'stars'){
      window.open(BOT_BUY_URL, '_blank');
      onClose();
      return;
    }
    setBusy(method);
    try {
      const r = await fetch(apiEndpoint,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({package_id: pkg.id, method})
      });
      const j = await r.json();
      if(!r.ok){ toast(j.error||'ÐžÑˆÐ¸Ð±ÐºÐ°','err'); return; }
      window.open(j.url,'_blank');
      onClose();
      toast(note||'Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚Ðµ Ð¾Ð¿Ð»Ð°Ñ‚Ñƒ â€” Ð·Ð°Ñ‡Ð¸ÑÐ»Ð¸Ñ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸');
    } catch(e){
      toast('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ‚Ð¸','err');
    } finally {
      setBusy(null);
    }
  },[pkg, onClose, apiEndpoint, note]);

  const METHODS = [
    ...(showStars ? [{key:'stars', icon:'â­', name:'Telegram Stars', price: (pkg.stars||'?')+' Stars'}] : []),
    {key:'yookassa', icon:'ðŸ’³', name:'Ð‘Ð°Ð½ÐºÐ¾Ð²ÑÐºÐ°Ñ ÐºÐ°Ñ€Ñ‚Ð°', price: pkg.rub.toLocaleString('ru-RU')+' â‚½'},
    {key:'crypto',   icon:'â˜ï¸', name:'Crypto Cloud (USDT)', price: pkg.usd+' USDT'},
  ];

  return h('div',{className:'pay-overlay', onClick:e=>{ if(e.target===e.currentTarget) onClose(); }},
    h('div',{className:'pay-modal'},
      h('div',{className:'pay-head'},
        h('div',{className:'pay-pkg-info'},
          h('span',{className:'pay-pkg-coins'},title),
          sub && h('span',{className:'pay-pkg-sub'},sub)
        ),
        h('button',{className:'pay-close',onClick:onClose},'âœ•')
      ),
      h('div',{className:'pay-subtitle'},'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐ¿Ð¾ÑÐ¾Ð± Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹'),
      h('div',{className:'pay-methods'},
        METHODS.map(m=>
          h('button',{
            key:m.key,
            className:'pay-btn',
            disabled:busy===m.key,
            onClick:()=>pay(m.key)
          },
            h('span',{className:'pay-btn-icon'},m.icon),
            h('div',{className:'pay-btn-info'},
              h('div',{className:'pay-btn-name'},m.name),
              h('div',{className:'pay-btn-price'},m.price)
            ),
            h('span',{className:'pay-btn-arrow'},busy===m.key?'â€¦':'â€º')
          )
        )
      ),
      h('p',{className:'pay-note'},'Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð°Ñ Ð¾Ð¿Ð»Ð°Ñ‚Ð° Â· Ð—Ð°Ñ‡Ð¸ÑÐ»ÑÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸')
    )
  );
}

// â”€â”€ Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² ÑˆÐ°Ñ€Ð¸ÐºÐ¾Ð² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function BuyCoins(){
  const [modal, setModal] = useState(null);

  const open = useCallback(pkg=>{
    if(!USER_ID){ toast('Ð’Ð¾Ð¹Ð´Ð¸Ñ‚Ðµ Ñ‡ÐµÑ€ÐµÐ· Telegram','err'); return; }
    setModal(pkg);
  },[]);

  return h(Fragment,null,
    modal && h(PayModal,{
      pkg:modal,
      onClose:()=>setModal(null),
      apiEndpoint:'/api/shop/create-payment',
      title: h(Fragment,null, h('img',{src:'/static/bubbles.svg',style:{width:'1em',height:'1em',verticalAlign:'-0.1em',marginRight:'4px'},alt:''}), modal.coins.toLocaleString()),
      sub: ' ÑˆÐ°Ñ€Ð¸ÐºÐ¾Ð²',
      showStars: true,
    }),
    h('div',{className:'section-head'},'ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ ÑˆÐ°Ñ€Ð¸ÐºÐ¸'),
    h('p',{style:{color:'var(--text-3)',fontSize:'.8rem',marginBottom:'1rem'}},
      'Ð¨Ð°Ñ€Ð¸ÐºÐ¸ Ñ‚Ñ€Ð°Ñ‚ÑÑ‚ÑÑ Ð² Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ðµ Ð½Ð° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ñ‹, Ñ€Ð°Ð¼ÐºÐ¸, Ñ„Ð¾Ð½Ñ‹ Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ðµ ÑƒÐºÑ€Ð°ÑˆÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ.'
    ),
    h('div',{className:'coins-grid'},
      COIN_PACKAGES_STATIC.map(pkg=>
        h('div',{key:pkg.id,className:'coin-pkg-card'},
          h('div',{className:'coin-pkg-amount'},
            h('img',{src:'/static/bubbles.svg',style:{width:'1em',height:'1em',verticalAlign:'-0.1em',marginRight:'5px'},alt:''}),
            pkg.coins.toLocaleString()
          ),
          h('div',{className:'coin-pkg-label'},'ÑˆÐ°Ñ€Ð¸ÐºÐ¾Ð²'),
          h('div',{className:'coin-pkg-price'},'Ð¾Ñ‚ '+pkg.rub.toLocaleString('ru-RU')+' â‚½'),
          h('button',{
            className:'btn-stars',
            style:{marginTop:'.4rem', width:'100%'},
            onClick:()=>open(pkg)
          },'ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ')
        )
      )
    )
  );
}

// â”€â”€ Premium Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function BuyPremium(){
  const [modal, setModal] = useState(null);

  const open = useCallback(pkg=>{
    if(!USER_ID){ toast('Ð’Ð¾Ð¹Ð´Ð¸Ñ‚Ðµ Ñ‡ÐµÑ€ÐµÐ· Telegram','err'); return; }
    setModal(pkg);
  },[]);

  // Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð°Ñ‚Ñƒ Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ñ Premium
  let premExpStr = null;
  if(IS_PREMIUM && PREMIUM_EXPIRES){
    try{
      const ds = PREMIUM_EXPIRES.includes('+')||PREMIUM_EXPIRES.endsWith('Z') ? PREMIUM_EXPIRES : PREMIUM_EXPIRES+'Z';
      premExpStr = new Date(ds).toLocaleDateString('ru-RU',{day:'numeric',month:'long',year:'numeric'});
    }catch(e){ premExpStr = PREMIUM_EXPIRES.slice(0,10); }
  }

  return h(Fragment,null,
    modal && h(PayModal,{
      pkg: modal,
      onClose: ()=>setModal(null),
      apiEndpoint: '/api/shop/create-premium-payment',
      title: 'Premium '+modal.name,
      sub: null,
      showStars: false,
    }),
    h('div',{className:'section-head'},'Premium Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ°'),
    h('p',{style:{color:'var(--text-3)',fontSize:'.8rem',marginBottom:'1rem'}},
      'ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ð¹ Ð½Ð¾Ð²Ñ‹Ðµ Ð³Ð»Ð°Ð²Ñ‹ Ð² Telegram ÑÑ€Ð°Ð·Ñƒ Ð¿Ñ€Ð¸ Ð²Ñ‹Ñ…Ð¾Ð´Ðµ â€” Ð¸ Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°Ð¹ ÑÐºÑÐºÐ»ÑŽÐ·Ð¸Ð²Ð½Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ.'
    ),
    h('div',{className:'premium-grid'},
      PREMIUM_PACKAGES_STATIC.map(pkg=>
        h('div',{key:pkg.id, className:'prem-pkg-card'+(pkg.popular?' popular':'')},
          pkg.popular && h('div',{className:'prem-popular-badge'},'ÐŸÐ¾Ð¿ÑƒÐ»ÑÑ€Ð½Ð¾'),
          h('div',{className:'prem-pkg-name'},pkg.name),
          h('div',{className:'prem-features'},
            h('div',{className:'prem-feature-main'},
              h('span',{className:'prem-feature-main-icon'},'ðŸ””'),
              PREMIUM_MAIN_FEATURE
            ),
            PREMIUM_FEATURES.map((f,i)=>h('div',{key:i,className:'prem-feature'},f))
          ),
          h('div',{className:'prem-pkg-price'},'Ð¾Ñ‚ '+pkg.rub.toLocaleString('ru-RU')+' â‚½'),
          h('button',{
            className:'btn-premium',
            style:{marginTop:'.2rem'},
            onClick:()=>open(pkg)
          }, IS_PREMIUM ? 'ÐŸÑ€Ð¾Ð´Ð»Ð¸Ñ‚ÑŒ' : 'ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ')
        )
      )
    )
  );
}

// â”€â”€ Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ShopPage(){
  const [coins,   setCoins]  = useState(INIT_COINS);
  const [activeTab, setTab]  = useState('all');
  const [eqMap,   setEqMap]  = useState({...EQUIPPED});

  const buy = useCallback(async item=>{
    const r = await fetch(`/api/shop/buy/${item.id}`,{method:'POST'});
    const j = await r.json();
    if(!r.ok){ toast(j.error||'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ¸','err'); return; }
    OWNED_IDS.add(item.id); LOANED_IDS.delete(item.id);
    setCoins(j.coins??j.bubbles??0);
    toast(`ÐšÑƒÐ¿Ð»ÐµÐ½Ð¾: ${item.name}`);
  },[]);

  const equip = useCallback(async item=>{
    const r = await fetch(`/api/profile/equip/${item.id}`,{method:'POST'});
    const j = await r.json();
    if(!r.ok){ toast(j.error||'ÐžÑˆÐ¸Ð±ÐºÐ°','err'); return; }
    setEqMap(prev=>{
      const next={...prev};
      if(j.equipped){
        ALL_ITEMS.filter(i=>i.type===item.type&&i.id!==item.id).forEach(i=>delete next[i.id]);
        next[item.id]=true; EQUIPPED[item.id]=true;
      } else {
        delete next[item.id]; delete EQUIPPED[item.id];
      }
      return next;
    });
    toast(j.equipped?`ÐÐ°Ð´ÐµÑ‚Ð¾: ${item.name}`:`Ð¡Ð½ÑÑ‚Ð¾: ${item.name}`);
  },[]);

  const activate = useCallback(async item=>{
    const r = await fetch(`/api/shop/activate/${item.id}`,{method:'POST'});
    const j = await r.json();
    if(!r.ok){ toast(j.error||'ÐžÑˆÐ¸Ð±ÐºÐ° Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸','err'); return; }
    OWNED_IDS.add(item.id); LOANED_IDS.add(item.id);
    toast(`ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾: ${item.name}`);
  },[]);

  const visible = useMemo(()=>{
    if(activeTab==='all')   return ALL_ITEMS;
    if(activeTab==='other') return ALL_ITEMS.filter(i=>OTHER_TYPES.has(i.type));
    return ALL_ITEMS.filter(i=>i.type===activeTab);
  },[activeTab]);

  function renderGrid(items,type){
    if(!items.length) return h('div',{className:'empty-section'},h('div',{className:'eico'},'ðŸ›ï¸'),h('div',null,'ÐŸÐ¾ÐºÐ° Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½ÐµÑ‚'));
    const gc = type==='avatar' ? 'items-grid-avatar' : 'items-grid';
    return h('div',{className:gc},
      items.map(item=>h(ItemCard,{key:item.id,item,coins,eqMap,onBuy:buy,onEquip:equip,onActivate:activate}))
    );
  }

  function renderAll(){
    const groups={};
    visible.forEach(i=>{ (groups[i.type]||(groups[i.type]=[])).push(i); });
    return GROUP_ORDER.filter(t=>groups[t]).map(type=>
      h(Fragment,{key:type},
        h('div',{className:'section-head'},GROUP_LABELS[type]||type),
        renderGrid(groups[type],type)
      )
    );
  }

  // Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Premium Ð´Ð°Ñ‚Ñƒ
  let premiumExpStr=null;
  if(IS_PREMIUM&&PREMIUM_EXPIRES){
    try{
      const ds=PREMIUM_EXPIRES.includes('+')||PREMIUM_EXPIRES.endsWith('Z')?PREMIUM_EXPIRES:PREMIUM_EXPIRES+'Z';
      premiumExpStr=new Date(ds).toLocaleDateString('ru-RU',{day:'numeric',month:'long',year:'numeric'});
    }catch(e){ premiumExpStr=PREMIUM_EXPIRES.slice(0,10); }
  }

  return h(Fragment,null,
    h('div',{className:'shop-hero'},
      h('h1',null,'ðŸ›’ ÐœÐ°Ð³Ð°Ð·Ð¸Ð½'),
      h('p',null,'Ð£ÐºÑ€Ð°ÑˆÐ°Ð¹ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ â€” Ð¿Ð¾ÐºÑƒÐ¿Ð°Ð¹ Ð·Ð° ÑˆÐ°Ñ€Ð¸ÐºÐ¸, Ð·Ð°Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ðµ Ñ‡Ñ‚ÐµÐ½Ð¸ÐµÐ¼'),
      (USER_ID || (IS_PREMIUM&&premiumExpStr)) && h('div',{className:'hero-badges'},
        USER_ID && h('div',{className:'balance-chip'},
          h('img',{src:'/static/bubbles.svg',style:{width:'1.1em',height:'1.1em',verticalAlign:'-0.2em'},alt:''}),' ',
          h('span',null,coins.toLocaleString(),' ÑˆÐ°Ñ€Ð¸ÐºÐ¾Ð²')
        ),
        IS_PREMIUM&&premiumExpStr && h('div',{className:'premium-banner'},'â­ Premium Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½ Ð´Ð¾ ',premiumExpStr)
      )
    ),

    h('div',{className:'shop-tabs-wrap'},
      h('div',{className:'shop-tabs'},
        TABS.map(t=>h('button',{key:t.id,className:`shop-tab${activeTab===t.id?' active':''}`,onClick:()=>setTab(t.id)},t.label))
      )
    ),

    h('div',{className:'shop-container'},
      activeTab==='buy'     ? h(BuyCoins,null)   :
      activeTab==='premium' ? h(BuyPremium,null) :
      h(Fragment,null,
        !USER_ID && h('div',{className:'login-notice'},'Ð§Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾ÐºÑƒÐ¿Ð°Ñ‚ÑŒ, ',h('a',{href:'/'},'Ð²Ð¾Ð¹Ð´Ð¸ Ñ‡ÐµÑ€ÐµÐ· Telegram')),
        activeTab==='all'
          ? h(Fragment,null, h(BuyPremium,null), h(BuyCoins,null), renderAll())
          : renderGrid(visible, activeTab)
      )
    )
  );
}

createRoot(document.getElementById('shop-root')).render(h(ShopPage));
</script>

{%- include 'footer.html' %}
</body>
</html>
