<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0"/>
  <meta name="theme-color" content="#667eea"/>
  <title>–¢–æ–ø –∫–æ–ª–ª–µ–∫—Ü–∏–π ‚Äî BubbleManga</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    :root {
      --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --accent: #667eea;
      --bg: #0a0a0a;
      --card: #1a1a1a;
      --card2: #141414;
      --border: rgba(255,255,255,.06);
      --text: #ffffff;
      --text-2: #b8b8b8;
      --text-3: #71717a;
    }
    html, body {
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg); color: var(--text);
      -webkit-font-smoothing: antialiased; line-height: 1.6;
    }
    a { color: inherit; text-decoration: none; }
    .page-wrap { padding-top: 72px; }

    /* ‚îÄ‚îÄ Hero ‚îÄ‚îÄ */
    .hero-section {
      text-align: center; padding: 3.5rem 1rem 2.5rem;
      background: linear-gradient(135deg, #08081a 0%, #0f0c2a 50%, #10091e 100%);
      border-bottom: 1px solid var(--border);
    }
    .hero-section h1 {
      font-size: 2.4rem; font-weight: 800;
      background: var(--primary);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
      margin-bottom: .4rem;
    }
    .hero-section p { color: var(--text-2); font-size: .92rem; }

    /* ‚îÄ‚îÄ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚îÄ‚îÄ */
    .top-container { max-width: 1100px; margin: 0 auto; padding: 2rem 1.25rem; }

    /* ‚îÄ‚îÄ –°–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ ‚îÄ‚îÄ */
    .colls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
      gap: 1.25rem;
    }
    @media (max-width: 600px) {
      .colls-grid { grid-template-columns: 1fr; }
    }

    /* ‚îÄ‚îÄ –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ ‚îÄ‚îÄ */
    .coll-card {
      background: var(--card2); border: 1px solid var(--border); border-radius: 16px;
      overflow: hidden; transition: transform .2s, border-color .2s;
      display: flex; flex-direction: column;
    }
    .coll-card:hover { transform: translateY(-4px); border-color: rgba(102,126,234,.35); }

    .coll-card-cover {
      width: 100%; height: 140px; position: relative; overflow: hidden;
      background: linear-gradient(135deg, #0f0c2a 0%, #1a1040 100%);
      flex-shrink: 0;
    }
    .coll-card-cover img {
      width: 100%; height: 100%; object-fit: cover;
      transition: transform .3s;
    }
    .coll-card:hover .coll-card-cover img { transform: scale(1.04); }
    .coll-card-cover-placeholder {
      width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      font-size: 2.8rem;
      background: linear-gradient(135deg, #0d0d28 0%, #1a1040 100%);
    }
    .coll-rank {
      position: absolute; top: .6rem; left: .6rem;
      background: rgba(0,0,0,.65); border: 1px solid rgba(255,255,255,.12);
      border-radius: 20px; padding: .15rem .6rem;
      font-size: .72rem; font-weight: 800; color: var(--text-2);
    }
    .coll-rank.gold { color: #FFD700; border-color: rgba(255,215,0,.3); background: rgba(255,215,0,.1); }
    .coll-rank.silver { color: #C0C0C0; border-color: rgba(192,192,192,.3); background: rgba(192,192,192,.08); }
    .coll-rank.bronze { color: #CD7F32; border-color: rgba(205,127,50,.3); background: rgba(205,127,50,.08); }

    .coll-card-body { padding: .9rem 1rem; flex: 1; display: flex; flex-direction: column; gap: .35rem; }
    .coll-card-name {
      font-size: .95rem; font-weight: 700; color: #f4f4f5;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .coll-card-desc {
      font-size: .75rem; color: var(--text-3); line-height: 1.45;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
      overflow: hidden; flex: 1;
    }
    .coll-card-footer {
      display: flex; align-items: center; justify-content: space-between;
      padding: .5rem 1rem .85rem; gap: .5rem;
    }
    .coll-owner {
      display: flex; align-items: center; gap: .4rem;
      color: var(--text-3); font-size: .75rem; font-weight: 500;
      min-width: 0; overflow: hidden;
    }
    .coll-owner-ava {
      width: 22px; height: 22px; border-radius: 50%; flex-shrink: 0; overflow: hidden;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex; align-items: center; justify-content: center;
      font-size: .6rem; font-weight: 700;
    }
    .coll-owner-ava img { width: 100%; height: 100%; object-fit: cover; }
    .coll-owner-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .coll-owner:hover { color: #818cf8; }

    .coll-actions { display: flex; align-items: center; gap: .5rem; flex-shrink: 0; }
    .coll-stat { font-size: .75rem; color: var(--text-3); white-space: nowrap; }
    .btn-like-sm {
      display: inline-flex; align-items: center; gap: .25rem;
      padding: .25rem .6rem; border-radius: 14px;
      border: 1px solid rgba(255,255,255,.1); background: rgba(255,255,255,.04);
      color: var(--text-3); font-size: .76rem; font-weight: 600;
      cursor: pointer; transition: all .18s; font-family: inherit;
    }
    .btn-like-sm:hover { border-color: #ef4444; color: #ef4444; background: rgba(239,68,68,.08); }
    .btn-like-sm.liked { border-color: rgba(239,68,68,.35); color: #ef4444; background: rgba(239,68,68,.1); }
    .btn-like-sm:disabled { opacity: .4; cursor: not-allowed; }
    .btn-open {
      display: inline-flex; align-items: center;
      padding: .28rem .7rem; border-radius: 14px;
      background: rgba(102,126,234,.12); border: 1px solid rgba(102,126,234,.25);
      color: #818cf8; font-size: .76rem; font-weight: 600;
      cursor: pointer; transition: background .15s; font-family: inherit; text-decoration: none;
    }
    .btn-open:hover { background: rgba(102,126,234,.22); }

    /* ‚îÄ‚îÄ –ü—É—Å—Ç–æ ‚îÄ‚îÄ */
    .empty-state { text-align: center; padding: 4rem 1rem; color: var(--text-3); }
    .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }

    /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(60px);
      background: #27272a; border: 1px solid rgba(255,255,255,.1); border-radius: 12px;
      padding: 10px 18px; font-size: 13px; font-weight: 600;
      opacity: 0; transition: all .3s; z-index: 9000; white-space: nowrap; pointer-events: none;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast.success { border-color: rgba(74,222,128,.3); color: #4ade80; }
    .toast.error { border-color: rgba(239,68,68,.3); color: #ef4444; }
  </style>
</head>
<body>

{% set g_active = 'collections_top' %}{% include 'header.html' %}

<div class="page-wrap">
  <div class="hero-section">
    <h1>–¢–æ–ø –∫–æ–ª–ª–µ–∫—Ü–∏–π</h1>
    <p>–õ—É—á—à–∏–µ –ø–æ–¥–±–æ—Ä–∫–∏ –º–∞–Ω–≥–∏ –æ—Ç —á–∏—Ç–∞—Ç–µ–ª–µ–π ‚Äî –ø–æ—Å—Ç–∞–≤—å –ª–∞–π–∫ –ª—é–±–∏–º—ã–º</p>
  </div>

  <div class="top-container">
    {% if collections %}
    <div class="colls-grid">
      {% for coll in collections %}
      {% set rank = loop.index %}
      <div class="coll-card">
        <div class="coll-card-cover">
          {% if coll.cover_url %}
            <img src="{{ coll.cover_url }}" alt="{{ coll.name }}" loading="lazy">
          {% else %}
            <div class="coll-card-cover-placeholder">üìÅ</div>
          {% endif %}
          <div class="coll-rank{% if rank == 1 %} gold{% elif rank == 2 %} silver{% elif rank == 3 %} bronze{% endif %}">
            #{{ rank }}
          </div>
        </div>
        <div class="coll-card-body">
          <div class="coll-card-name">{{ coll.name }}</div>
          {% if coll.description %}
            <div class="coll-card-desc">{{ coll.description }}</div>
          {% else %}
            <div class="coll-card-desc" style="font-style:italic">–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è</div>
          {% endif %}
        </div>
        <div class="coll-card-footer">
          <a href="/profile/{{ coll.user_id }}" class="coll-owner" onclick="event.stopPropagation()">
            <div class="coll-owner-ava">
              {% if coll.owner_avatar %}
                <img src="{{ coll.owner_avatar }}" alt="">
              {% else %}
                {{ (coll.owner_name or '?')[0]|upper }}
              {% endif %}
            </div>
            <span class="coll-owner-name">{{ coll.owner_name }}</span>
          </a>
          <div class="coll-actions">
            <span class="coll-stat">üìö{{ coll.items_count }}</span>
            <button class="btn-like-sm{% if coll.id in my_likes %} liked{% endif %}"
                    id="like-{{ coll.id }}"
                    data-id="{{ coll.id }}"
                    data-liked="{{ 'true' if coll.id in my_likes else 'false' }}"
                    data-count="{{ coll.likes_count }}"
                    {% if not user_id %}disabled{% endif %}
                    onclick="toggleLike({{ coll.id }}, this)">
              <span>{% if coll.id in my_likes %}‚ù§Ô∏è{% else %}ü§ç{% endif %}</span>
              <span id="lc-{{ coll.id }}">{{ coll.likes_count }}</span>
            </button>
            <a class="btn-open" href="/collection/{{ coll.id }}">–û—Ç–∫—Ä—ã—Ç—å</a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
      <div class="empty-state-icon">üì≠</div>
      <div>–ö–æ–ª–ª–µ–∫—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π –ø–µ—Ä–≤—É—é –≤ —Å–≤–æ—ë–º –ø—Ä–æ—Ñ–∏–ª–µ!</div>
    </div>
    {% endif %}
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const USER_ID = {{ user_id | tojson }};

function toast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + (type || '');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

async function toggleLike(collId, btn) {
  if (!USER_ID) return;
  btn.disabled = true;
  const liked = btn.dataset.liked === 'true';
  try {
    const method = liked ? 'DELETE' : 'POST';
    const r = await fetch(`/api/collections/${collId}/like`, { method });
    const d = await r.json();
    if (d.success) {
      const newLiked = !liked;
      btn.dataset.liked = newLiked ? 'true' : 'false';
      btn.dataset.count = d.likes_count;
      btn.querySelector('span:first-child').textContent = newLiked ? '‚ù§Ô∏è' : 'ü§ç';
      document.getElementById('lc-' + collId).textContent = d.likes_count;
      btn.className = 'btn-like-sm' + (newLiked ? ' liked' : '');
      toast(newLiked ? '–õ–∞–π–∫ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω' : '–õ–∞–π–∫ —É–±—Ä–∞–Ω', 'success');
    } else {
      toast(d.error || '–û—à–∏–±–∫–∞', 'error');
    }
  } catch(e) {
    toast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
  }
  btn.disabled = false;
}
</script>

{%- include 'footer.html' %}
</body>
</html>
