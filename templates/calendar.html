<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0"/>
  <meta name="theme-color" content="#667eea"/>
  <title>Календарь манги — BubbleManga</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    :root {
      --primary-g: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg: #0a0a0a;
      --card: #141414;
      --card2: #1a1a1a;
      --border: rgba(255,255,255,.07);
      --text: #ffffff;
      --text-2: #a1a1aa;
      --text-3: #52525b;
    }
    html, body {
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg); color: var(--text);
      -webkit-font-smoothing: antialiased; line-height: 1.5;
    }

    /* ── Wrapper ── */
    .cal-wrap {
      max-width: 860px;
      margin: 0 auto;
      padding: 28px 16px 48px;
    }
    .cal-page-title {
      font-size: 22px;
      font-weight: 800;
      background: var(--primary-g);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 24px;
    }

    /* ── Calendar card ── */
    .cal-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      overflow: hidden;
    }

    /* ── Month navigation ── */
    .cal-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 20px 16px;
      border-bottom: 1px solid var(--border);
    }
    .cal-nav-btn {
      width: 36px; height: 36px;
      border-radius: 10px;
      background: rgba(255,255,255,.05);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 20px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background .15s, border-color .15s;
      line-height: 1; padding: 0;
    }
    .cal-nav-btn:hover { background: rgba(102,126,234,.15); border-color: rgba(102,126,234,.4); }
    .cal-month-label { font-size: 17px; font-weight: 700; letter-spacing: -.3px; }
    .cal-month-label span { color: var(--text-2); font-weight: 400; margin-left: 6px; font-size: 15px; }

    /* ── Weekday headers ── */
    .cal-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      padding: 10px 16px 6px;
    }
    .cal-weekdays div {
      text-align: center;
      font-size: 11px; font-weight: 600;
      color: var(--text-3);
      text-transform: uppercase; letter-spacing: .6px;
    }
    .cal-weekdays .wd-weekend { color: rgba(236,72,153,.5); }

    /* ── Calendar grid ── */
    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      padding: 4px 16px 20px;
    }

    /* ── Day cell ── */
    .cal-day {
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: default;
      position: relative;
      transition: background .15s;
      gap: 2px;
      min-width: 0;
      padding: 8px 2px;
      min-height: 54px;
    }
    .cal-day-num {
      font-size: 14px; font-weight: 500;
      line-height: 1; color: var(--text-2);
    }
    .cal-day-count {
      font-size: 9px; font-weight: 700;
      color: #818cf8;
      line-height: 1;
      letter-spacing: .2px;
      white-space: nowrap;
      display: none;
    }

    .cal-day.other-month .cal-day-num { color: var(--text-3); }
    .cal-day.other-month .cal-day-count { color: rgba(129,140,248,.4); }

    /* Today */
    .cal-day.today .cal-day-num { color: #fff; }
    .cal-day.today::before {
      content: '';
      position: absolute; inset: 0;
      border: 1.5px solid rgba(255,255,255,.22);
      border-radius: 10px; pointer-events: none;
    }

    /* Has chapters */
    .cal-day.has-chapters { cursor: pointer; }
    .cal-day.has-chapters .cal-day-num { color: #e4e4e7; }
    .cal-day.has-chapters .cal-day-count { display: block; }
    .cal-day.has-chapters:hover { background: rgba(102,126,234,.12); }

    /* Selected */
    .cal-day.selected {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
      cursor: pointer;
    }
    .cal-day.selected .cal-day-num { color: #fff; font-weight: 700; }
    .cal-day.selected .cal-day-count { color: rgba(255,255,255,.8); }
    .cal-day.selected::before { display: none; }

    /* ── Modal backdrop ── */
    .cal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.6);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      z-index: 600;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity .22s ease;
    }
    .cal-backdrop.open {
      opacity: 1;
      pointer-events: all;
    }

    /* ── Modal ── */
    .cal-modal {
      background: #181818;
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 22px 22px 0 0;
      width: 100%;
      max-width: 620px;
      max-height: 82vh;
      display: flex;
      flex-direction: column;
      transform: translateY(100%);
      transition: transform .28s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .cal-backdrop.open .cal-modal {
      transform: translateY(0);
    }
    @media (min-width: 640px) {
      .cal-backdrop { align-items: center; padding: 24px; }
      .cal-modal {
        border-radius: 22px;
        transform: translateY(16px) scale(.97);
        max-height: 78vh;
      }
      .cal-backdrop.open .cal-modal { transform: translateY(0) scale(1); }
    }

    /* Modal handle (mobile) */
    .cal-modal-handle {
      width: 36px; height: 4px;
      background: rgba(255,255,255,.15);
      border-radius: 2px;
      margin: 10px auto 0;
      flex-shrink: 0;
    }
    @media (min-width: 640px) { .cal-modal-handle { display: none; } }

    /* Modal header */
    .cal-modal-head {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      padding: 16px 20px 14px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .cal-modal-title {
      font-size: 16px; font-weight: 700;
    }
    .cal-modal-sub {
      font-size: 12px; color: #818cf8;
      margin-top: 2px;
    }
    .cal-modal-close {
      width: 36px; height: 36px;
      border-radius: 10px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      color: #e4e4e7;
      font-size: 20px; line-height: 1;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; padding: 0;
      transition: background .15s, color .15s;
    }
    .cal-modal-close:hover { background: rgba(255,255,255,.15); color: #fff; }
    @media (max-width: 639px) {
      .cal-modal-close {
        width: 42px; height: 42px;
        border-radius: 12px;
        font-size: 22px;
        background: rgba(255,255,255,.1);
      }
    }

    /* Modal body */
    .cal-modal-body {
      overflow-y: auto;
      padding: 16px 20px 28px;
      flex: 1;
      overscroll-behavior: contain;
    }
    .cal-modal-body::-webkit-scrollbar { width: 4px; }
    .cal-modal-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,.12); border-radius: 2px; }

    /* Spinner / status */
    .cal-status {
      display: flex; align-items: center; justify-content: center;
      gap: 8px; color: var(--text-3);
      font-size: 13px; padding: 28px 0;
    }
    .cal-spinner {
      width: 16px; height: 16px;
      border: 2px solid rgba(255,255,255,.1);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Grouped chapter list */
    .cal-group { margin-bottom: 16px; }
    .cal-group:last-child { margin-bottom: 0; }
    .cal-group-label {
      display: flex; align-items: center; gap: 10px;
      margin-bottom: 8px;
    }
    .cal-group-label img {
      width: 30px; height: 40px;
      border-radius: 5px; object-fit: cover;
      flex-shrink: 0; background: #222;
    }
    .cal-group-label a {
      font-size: 13px; font-weight: 700;
      color: #e4e4e7; text-decoration: none;
    }
    .cal-group-label a:hover { color: #818cf8; }
    .cal-group-chapters { display: flex; flex-direction: column; gap: 5px; padding-left: 40px; }
    .cal-ch {
      display: flex; align-items: center; gap: 8px;
      padding: 7px 10px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      border-radius: 9px;
      text-decoration: none; color: inherit;
      transition: background .14s, border-color .14s;
    }
    .cal-ch:hover { background: rgba(102,126,234,.08); border-color: rgba(102,126,234,.3); }
    .cal-ch-num { font-size: 12px; font-weight: 700; color: #818cf8; flex-shrink: 0; }
    .cal-ch-name { font-size: 11px; color: var(--text-2); flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .cal-ch-arr { color: var(--text-3); font-size: 13px; flex-shrink: 0; }

    /* Responsive */
    @media (max-width: 480px) {
      .cal-wrap { padding: 14px 8px 40px; }
      .cal-grid { gap: 2px; padding: 4px 10px 14px; }
      .cal-weekdays { padding: 8px 10px 4px; }
      .cal-day { min-height: 46px; padding: 6px 1px; }
      .cal-day-num { font-size: 13px; }
      .cal-day-count { font-size: 8px; }
      .cal-modal-head { padding: 14px 16px 12px; }
      .cal-modal-body { padding: 12px 16px 24px; }
    }
  </style>
</head>
<body>
{% set g_active = 'calendar' %}{% include 'header.html' %}

<main class="cal-wrap">
  <h1 class="cal-page-title">Календарь манги</h1>

  <div class="cal-card">
    <div class="cal-nav">
      <button class="cal-nav-btn" onclick="shiftMonth(-1)">‹</button>
      <div class="cal-month-label" id="monthLabel"></div>
      <button class="cal-nav-btn" onclick="shiftMonth(1)">›</button>
    </div>
    <div class="cal-weekdays">
      <div>Пн</div><div>Вт</div><div>Ср</div><div>Чт</div><div>Пт</div>
      <div class="wd-weekend">Сб</div><div class="wd-weekend">Вс</div>
    </div>
    <div class="cal-grid" id="calGrid"></div>
  </div>
</main>

<!-- Modal -->
<div class="cal-backdrop" id="backdrop" onclick="handleBackdropClick(event)">
  <div class="cal-modal" id="modal">
    <div class="cal-modal-handle"></div>
    <div class="cal-modal-head">
      <div>
        <div class="cal-modal-title" id="modalTitle"></div>
        <div class="cal-modal-sub" id="modalSub"></div>
      </div>
      <button class="cal-modal-close" onclick="closeModal()">×</button>
    </div>
    <div class="cal-modal-body" id="modalBody">
      <div class="cal-status"><div class="cal-spinner"></div>Загружаем...</div>
    </div>
  </div>
</div>

{%- include 'footer.html' %}

<script>
(function () {
  const MONTHS_RU = ['Январь','Февраль','Март','Апрель','Май','Июнь',
                     'Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
  const MONTHS_GEN = ['января','февраля','марта','апреля','мая','июня',
                      'июля','августа','сентября','октября','ноября','декабря'];

  const today = new Date();
  let curYear  = today.getFullYear();
  let curMonth = today.getMonth() + 1;
  let selectedDate = null;
  let daysMap = {};

  function pad(n) { return String(n).padStart(2, '0'); }
  function dateStr(y, m, d) { return `${y}-${pad(m)}-${pad(d)}`; }
  function todayStr() { return dateStr(today.getFullYear(), today.getMonth()+1, today.getDate()); }

  function chapterWord(n) {
    if (n % 100 >= 11 && n % 100 <= 19) return 'глав';
    const r = n % 10;
    if (r === 1) return 'глава';
    if (r >= 2 && r <= 4) return 'главы';
    return 'глав';
  }

  function e(s) {
    if (s == null) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  /* ── Load days with chapters ── */
  async function loadDays(year, month) {
    daysMap = {};
    try {
      const r = await fetch(`/api/calendar/days?year=${year}&month=${month}`);
      const data = await r.json();
      data.forEach(item => { daysMap[item.day] = item.count; });
    } catch(err) {}
    renderGrid(year, month);
  }

  /* ── Render calendar grid ── */
  function renderGrid(year, month) {
    document.getElementById('monthLabel').innerHTML =
      `${MONTHS_RU[month-1]} <span>${year}</span>`;

    const grid = document.getElementById('calGrid');
    grid.innerHTML = '';

    const firstDay = new Date(year, month-1, 1).getDay();
    const startOffset = firstDay === 0 ? 6 : firstDay - 1;
    const daysInMonth = new Date(year, month, 0).getDate();
    const daysInPrev  = new Date(year, month-1, 0).getDate();
    const tdStr = todayStr();
    const total = Math.ceil((startOffset + daysInMonth) / 7) * 7;

    for (let i = 0; i < total; i++) {
      let day, y = year, m = month, other = false;

      if (i < startOffset) {
        day = daysInPrev - startOffset + i + 1;
        m = month - 1; if (m < 1) { m = 12; y--; }
        other = true;
      } else if (i >= startOffset + daysInMonth) {
        day = i - startOffset - daysInMonth + 1;
        m = month + 1; if (m > 12) { m = 1; y++; }
        other = true;
      } else {
        day = i - startOffset + 1;
      }

      const ds = dateStr(y, m, day);
      const count = daysMap[ds] || 0;

      const cell = document.createElement('div');
      cell.className = 'cal-day'
        + (other   ? ' other-month'  : '')
        + (count   ? ' has-chapters' : '')
        + (ds === tdStr       ? ' today'    : '')
        + (ds === selectedDate ? ' selected' : '');

      const countLabel = count ? `${count} ${chapterWord(count)}` : '';
      cell.innerHTML = `<span class="cal-day-num">${day}</span>`
                     + (count ? `<span class="cal-day-count">${countLabel}</span>` : '');

      if (count) cell.addEventListener('click', () => openDay(ds, count));
      grid.appendChild(cell);
    }
  }

  /* ── Month navigation ── */
  window.shiftMonth = function(delta) {
    curMonth += delta;
    if (curMonth > 12) { curMonth = 1;  curYear++; }
    if (curMonth < 1)  { curMonth = 12; curYear--; }
    selectedDate = null;
    loadDays(curYear, curMonth);
  };

  /* ── Open modal for a day ── */
  async function openDay(ds, count) {
    selectedDate = ds;
    renderGrid(curYear, curMonth);

    const [fy, fm, fd] = ds.split('-').map(Number);
    document.getElementById('modalTitle').textContent = `${fd} ${MONTHS_GEN[fm-1]} ${fy}`;
    document.getElementById('modalSub').textContent = `${count} ${chapterWord(count)}`;
    document.getElementById('modalBody').innerHTML =
      `<div class="cal-status"><div class="cal-spinner"></div>Загружаем...</div>`;

    // Open
    document.getElementById('backdrop').classList.add('open');
    document.body.style.overflow = 'hidden';

    let chapters = [];
    try {
      const r = await fetch(`/api/calendar/day?date=${ds}`);
      chapters = await r.json();
    } catch(err) {
      document.getElementById('modalBody').innerHTML =
        `<div class="cal-status">Ошибка загрузки</div>`;
      return;
    }

    if (!chapters.length) {
      document.getElementById('modalBody').innerHTML =
        `<div class="cal-status">Нет глав за этот день</div>`;
      return;
    }

    renderModalChapters(chapters);
  }

  function renderModalChapters(chapters) {
    // Group by manga_slug
    const groups = new Map();
    chapters.forEach(ch => {
      if (!groups.has(ch.manga_slug)) {
        groups.set(ch.manga_slug, { title: ch.manga_title, cover: ch.cover_url, slug: ch.manga_slug, items: [] });
      }
      groups.get(ch.manga_slug).items.push(ch);
    });

    let html = '';
    groups.forEach(g => {
      const cover = e(g.cover || '');
      html += `<div class="cal-group">
        <div class="cal-group-label">
          <img src="${cover}" alt="" loading="lazy"
               onerror="this.style.visibility='hidden'">
          <a href="/manga/${e(g.slug)}">${e(g.title)}</a>
        </div>
        <div class="cal-group-chapters">`;
      g.items.forEach(ch => {
        const url = ch.chapter_url || `/read/${e(ch.manga_slug)}/${e(ch.chapter_slug)}`;
        const num = ch.chapter_number ? `Глава ${e(ch.chapter_number)}` : 'Глава';
        const vol = ch.chapter_volume ? ` · Том ${e(ch.chapter_volume)}` : '';
        const name = ch.chapter_name ? e(ch.chapter_name) : '—';
        html += `<a href="${url}" class="cal-ch">
          <span class="cal-ch-num">${num}${vol}</span>
          <span class="cal-ch-name">${name}</span>
          <span class="cal-ch-arr">›</span>
        </a>`;
      });
      html += `</div></div>`;
    });

    document.getElementById('modalBody').innerHTML = html;
  }

  /* ── Close modal ── */
  window.closeModal = function() {
    document.getElementById('backdrop').classList.remove('open');
    document.body.style.overflow = '';
    selectedDate = null;
    renderGrid(curYear, curMonth);
  };

  window.handleBackdropClick = function(e) {
    if (e.target === document.getElementById('backdrop')) closeModal();
  };

  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeModal();
  });

  // Init
  loadDays(curYear, curMonth);
})();
</script>
</body>
</html>
