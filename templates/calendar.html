<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0"/>
  <meta name="theme-color" content="#667eea"/>
  <title>Календарь манги — BubbleManga</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    :root {
      --primary: #6366f1;
      --primary-g: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg: #0a0a0a;
      --card: #141414;
      --card2: #1a1a1a;
      --border: rgba(255,255,255,.07);
      --text: #ffffff;
      --text-2: #a1a1aa;
      --text-3: #52525b;
    }
    html, body {
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg); color: var(--text);
      -webkit-font-smoothing: antialiased; line-height: 1.5;
    }

    /* ── Wrapper ── */
    .cal-wrap {
      max-width: 900px;
      margin: 0 auto;
      padding: 28px 16px 48px;
    }

    /* ── Page title ── */
    .cal-page-title {
      font-size: 22px;
      font-weight: 800;
      background: var(--primary-g);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 24px;
    }

    /* ── Calendar card ── */
    .cal-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      overflow: hidden;
    }

    /* ── Month navigation ── */
    .cal-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 20px 16px;
      border-bottom: 1px solid var(--border);
    }
    .cal-nav-btn {
      width: 36px; height: 36px;
      border-radius: 10px;
      background: rgba(255,255,255,.05);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 20px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background .15s, border-color .15s;
      line-height: 1;
      padding: 0;
    }
    .cal-nav-btn:hover { background: rgba(102,126,234,.15); border-color: rgba(102,126,234,.4); }
    .cal-month-label {
      font-size: 17px;
      font-weight: 700;
      letter-spacing: -.3px;
    }
    .cal-month-label span { color: var(--text-2); font-weight: 400; margin-left: 6px; font-size: 15px; }

    /* ── Weekday headers ── */
    .cal-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      padding: 10px 16px 6px;
    }
    .cal-weekdays div {
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: .6px;
    }
    .cal-weekdays .wd-weekend { color: rgba(236,72,153,.5); }

    /* ── Calendar grid ── */
    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      padding: 4px 16px 16px;
    }

    /* ── Day cell ── */
    .cal-day {
      aspect-ratio: 1;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: default;
      position: relative;
      transition: background .15s;
      gap: 2px;
      min-width: 0;
    }
    .cal-day.other-month .cal-day-num { color: var(--text-3); }
    .cal-day.other-month .cal-dot { opacity: .35; }
    .cal-day-num {
      font-size: 13px;
      font-weight: 500;
      line-height: 1;
      color: var(--text-2);
    }
    .cal-day.today .cal-day-num {
      color: #fff;
    }
    .cal-day.today::before {
      content: '';
      position: absolute;
      inset: 0;
      border: 1.5px solid rgba(255,255,255,.25);
      border-radius: 10px;
      pointer-events: none;
    }

    /* Has-chapters: subtle background + dot */
    .cal-day.has-chapters {
      cursor: pointer;
    }
    .cal-day.has-chapters .cal-day-num { color: #e4e4e7; }
    .cal-day.has-chapters:hover { background: rgba(102,126,234,.12); }

    .cal-dot {
      width: 5px; height: 5px;
      border-radius: 50%;
      background: var(--primary-g);
      background: linear-gradient(135deg,#667eea,#764ba2);
      flex-shrink: 0;
    }
    .cal-day:not(.has-chapters) .cal-dot { display: none; }

    /* Selected day */
    .cal-day.selected {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
      cursor: pointer;
    }
    .cal-day.selected .cal-day-num { color: #fff; font-weight: 700; }
    .cal-day.selected .cal-dot { background: rgba(255,255,255,.6); }
    .cal-day.selected::before { display: none; }

    /* ── Chapters panel ── */
    .cal-panel {
      border-top: 1px solid var(--border);
      padding: 20px;
      min-height: 120px;
    }
    .cal-panel-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .cal-panel-date {
      font-size: 15px;
      font-weight: 700;
    }
    .cal-panel-count {
      font-size: 12px;
      color: var(--text-2);
      background: rgba(102,126,234,.12);
      border: 1px solid rgba(102,126,234,.25);
      border-radius: 20px;
      padding: 2px 10px;
    }

    /* Loading / empty */
    .cal-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: var(--text-3);
      font-size: 13px;
      padding: 24px 0;
    }
    .cal-spinner {
      width: 16px; height: 16px;
      border: 2px solid rgba(255,255,255,.1);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Chapter list */
    .cal-chapters-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* Chapter card */
    .cal-ch-card {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--card2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      text-decoration: none;
      color: inherit;
      transition: background .15s, border-color .15s;
    }
    .cal-ch-card:hover {
      background: rgba(102,126,234,.08);
      border-color: rgba(102,126,234,.3);
    }
    .cal-ch-cover {
      width: 38px; height: 52px;
      border-radius: 6px;
      object-fit: cover;
      flex-shrink: 0;
      background: #1f1f1f;
    }
    .cal-ch-info { flex: 1; min-width: 0; }
    .cal-ch-manga {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #e4e4e7;
    }
    .cal-ch-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 3px;
    }
    .cal-ch-num {
      font-size: 12px;
      color: #818cf8;
      font-weight: 600;
    }
    .cal-ch-name {
      font-size: 11px;
      color: var(--text-2);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .cal-ch-arrow {
      color: var(--text-3);
      font-size: 16px;
      flex-shrink: 0;
    }

    /* Grouped by manga */
    .cal-group-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 0 6px;
    }
    .cal-group-label img {
      width: 28px; height: 38px;
      border-radius: 5px;
      object-fit: cover;
      background: #1f1f1f;
    }
    .cal-group-label span {
      font-size: 13px;
      font-weight: 700;
      color: #e4e4e7;
    }
    .cal-group-chapters {
      display: flex;
      flex-direction: column;
      gap: 5px;
      padding-left: 36px;
    }
    .cal-group-ch {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      background: var(--card2);
      border: 1px solid var(--border);
      border-radius: 9px;
      text-decoration: none;
      color: inherit;
      transition: background .15s, border-color .15s;
    }
    .cal-group-ch:hover {
      background: rgba(102,126,234,.08);
      border-color: rgba(102,126,234,.3);
    }
    .cal-group-ch-num { font-size: 12px; font-weight: 700; color: #818cf8; }
    .cal-group-ch-name { font-size: 11px; color: var(--text-2); flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .cal-group-ch-arrow { color: var(--text-3); font-size: 13px; flex-shrink: 0; }

    /* Responsive */
    @media (max-width: 480px) {
      .cal-wrap { padding: 16px 10px 40px; }
      .cal-grid { gap: 2px; padding: 4px 10px 12px; }
      .cal-weekdays { padding: 8px 10px 4px; }
      .cal-day-num { font-size: 12px; }
      .cal-panel { padding: 16px 12px; }
    }
  </style>
</head>
<body>
{% set g_active = 'calendar' %}{% include 'header.html' %}

<main class="cal-wrap">
  <h1 class="cal-page-title">Календарь манги</h1>

  <div class="cal-card">
    <!-- Month navigation -->
    <div class="cal-nav">
      <button class="cal-nav-btn" id="prevBtn" onclick="shiftMonth(-1)">‹</button>
      <div class="cal-month-label" id="monthLabel"></div>
      <button class="cal-nav-btn" id="nextBtn" onclick="shiftMonth(1)">›</button>
    </div>

    <!-- Weekday headers -->
    <div class="cal-weekdays">
      <div>Пн</div><div>Вт</div><div>Ср</div><div>Чт</div><div>Пт</div>
      <div class="wd-weekend">Сб</div><div class="wd-weekend">Вс</div>
    </div>

    <!-- Day grid -->
    <div class="cal-grid" id="calGrid"></div>

    <!-- Chapters panel -->
    <div class="cal-panel" id="calPanel">
      <div class="cal-panel-head" id="panelHead" style="display:none">
        <div class="cal-panel-date" id="panelDate"></div>
        <div class="cal-panel-count" id="panelCount"></div>
      </div>
      <div id="chaptersBox">
        <div class="cal-status">Выберите дату</div>
      </div>
    </div>
  </div>
</main>

{%- include 'footer.html' %}
</body>

<script>
(function () {
  const MONTHS_RU = ['Январь','Февраль','Март','Апрель','Май','Июнь',
                     'Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];

  const today = new Date();
  let curYear  = today.getFullYear();
  let curMonth = today.getMonth() + 1; // 1-based
  let selectedDate = null;
  let daysMap = {};   // { 'YYYY-MM-DD': count }

  function pad(n) { return String(n).padStart(2, '0'); }
  function dateStr(y, m, d) { return `${y}-${pad(m)}-${pad(d)}`; }

  function todayStr() {
    return dateStr(today.getFullYear(), today.getMonth()+1, today.getDate());
  }

  /* ── Load which days have chapters ── */
  async function loadDays(year, month) {
    daysMap = {};
    try {
      const r = await fetch(`/api/calendar/days?year=${year}&month=${month}`);
      const data = await r.json();
      data.forEach(item => { daysMap[item.day] = item.count; });
    } catch(e) {}
    renderGrid(year, month);
  }

  /* ── Render calendar grid ── */
  function renderGrid(year, month) {
    // Month label
    document.getElementById('monthLabel').innerHTML =
      `${MONTHS_RU[month-1]} <span>${year}</span>`;

    const grid = document.getElementById('calGrid');
    grid.innerHTML = '';

    // First day of month (0=Sun…6=Sat → convert to Mon-first)
    const firstDay = new Date(year, month-1, 1).getDay();
    const startOffset = (firstDay === 0) ? 6 : firstDay - 1; // Mon=0..Sun=6

    const daysInMonth = new Date(year, month, 0).getDate();
    const daysInPrev  = new Date(year, month-1, 0).getDate();

    const tdStr = todayStr();
    const total = Math.ceil((startOffset + daysInMonth) / 7) * 7;

    for (let i = 0; i < total; i++) {
      let day, y = year, m = month, otherMonth = false;

      if (i < startOffset) {
        day = daysInPrev - startOffset + i + 1;
        m = month - 1; if (m < 1) { m = 12; y--; }
        otherMonth = true;
      } else if (i >= startOffset + daysInMonth) {
        day = i - startOffset - daysInMonth + 1;
        m = month + 1; if (m > 12) { m = 1; y++; }
        otherMonth = true;
      } else {
        day = i - startOffset + 1;
      }

      const ds = dateStr(y, m, day);
      const count = daysMap[ds] || 0;
      const isToday = (ds === tdStr);
      const isSelected = (ds === selectedDate);

      const cell = document.createElement('div');
      cell.className = 'cal-day'
        + (otherMonth ? ' other-month' : '')
        + (count > 0  ? ' has-chapters' : '')
        + (isToday    ? ' today'        : '')
        + (isSelected ? ' selected'     : '');

      cell.innerHTML = `<span class="cal-day-num">${day}</span>`
                     + (count > 0 ? `<span class="cal-dot"></span>` : '');

      if (count > 0) {
        cell.title = `${count} гл.`;
        cell.addEventListener('click', () => selectDay(ds));
      }

      grid.appendChild(cell);
    }
  }

  /* ── Month navigation ── */
  window.shiftMonth = function(delta) {
    curMonth += delta;
    if (curMonth > 12) { curMonth = 1;  curYear++; }
    if (curMonth < 1)  { curMonth = 12; curYear--; }
    selectedDate = null;
    resetPanel();
    loadDays(curYear, curMonth);
  };

  /* ── Select a day → fetch chapters ── */
  async function selectDay(ds) {
    selectedDate = ds;
    renderGrid(curYear, curMonth); // re-render to update selected

    // Show loading
    document.getElementById('panelHead').style.display = 'none';
    document.getElementById('chaptersBox').innerHTML =
      `<div class="cal-status"><div class="cal-spinner"></div>Загружаем...</div>`;

    let chapters = [];
    try {
      const r = await fetch(`/api/calendar/day?date=${ds}`);
      chapters = await r.json();
    } catch(e) {
      document.getElementById('chaptersBox').innerHTML =
        `<div class="cal-status">Ошибка загрузки</div>`;
      return;
    }

    // Format date for display
    const [fy, fm, fd] = ds.split('-').map(Number);
    const dateLabel = `${fd} ${MONTHS_RU[fm-1]} ${fy}`;
    document.getElementById('panelDate').textContent = dateLabel;
    document.getElementById('panelCount').textContent =
      `${chapters.length} ${chapterWord(chapters.length)}`;
    document.getElementById('panelHead').style.display = 'flex';

    if (!chapters.length) {
      document.getElementById('chaptersBox').innerHTML =
        `<div class="cal-status">Нет глав за этот день</div>`;
      return;
    }

    renderChapters(chapters);
  }

  /* ── Render chapters grouped by manga ── */
  function renderChapters(chapters) {
    // Group by manga_slug
    const groups = new Map();
    chapters.forEach(ch => {
      if (!groups.has(ch.manga_slug)) {
        groups.set(ch.manga_slug, { title: ch.manga_title, cover: ch.cover_url, chapters: [] });
      }
      groups.get(ch.manga_slug).chapters.push(ch);
    });

    let html = '<div class="cal-chapters-list">';
    groups.forEach((g, slug) => {
      const cover = e(g.cover || '');
      html += `<div class="cal-group-label">
        <img src="${cover}" alt="" loading="lazy"
             onerror="this.src='https://via.placeholder.com/28x38/1a1a1a/667eea?text='">
        <span>${e(g.title)}</span>
      </div>
      <div class="cal-group-chapters">`;
      g.chapters.forEach(ch => {
        const url = ch.chapter_url || `/read/${e(slug)}/${e(ch.chapter_slug)}`;
        const numLabel = ch.chapter_number ? `Глава ${e(ch.chapter_number)}` : 'Глава';
        const vol = ch.chapter_volume ? ` · Том ${e(ch.chapter_volume)}` : '';
        const name = ch.chapter_name ? ` · ${e(ch.chapter_name)}` : '';
        html += `<a href="${url}" class="cal-group-ch">
          <span class="cal-group-ch-num">${numLabel}${vol}</span>
          <span class="cal-group-ch-name">${name || '—'}</span>
          <span class="cal-group-ch-arrow">›</span>
        </a>`;
      });
      html += `</div>`;
    });
    html += '</div>';

    document.getElementById('chaptersBox').innerHTML = html;
  }

  function resetPanel() {
    document.getElementById('panelHead').style.display = 'none';
    document.getElementById('chaptersBox').innerHTML =
      `<div class="cal-status">Выберите дату</div>`;
  }

  function e(s) {
    if (s == null) return '';
    return String(s)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function chapterWord(n) {
    if (n % 100 >= 11 && n % 100 <= 19) return 'глав';
    const r = n % 10;
    if (r === 1) return 'глава';
    if (r >= 2 && r <= 4) return 'главы';
    return 'глав';
  }

  // Init
  loadDays(curYear, curMonth);
})();
</script>
</html>
