<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0"/>
  <meta name="theme-color" content="#667eea"/>
  <title>{{ coll.name }} ‚Äî BubbleManga</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    :root {
      --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --accent: #667eea;
      --bg: #0a0a0a;
      --card: #1a1a1a;
      --card2: #141414;
      --border: rgba(255,255,255,.06);
      --text: #ffffff;
      --text-2: #b8b8b8;
      --text-3: #71717a;
    }
    html, body {
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg); color: var(--text);
      -webkit-font-smoothing: antialiased; line-height: 1.6;
    }
    a { color: inherit; text-decoration: none; }

    .page-wrap { padding-top: 72px; }

    /* ‚îÄ‚îÄ Hero –∫–æ–ª–ª–µ–∫—Ü–∏–∏ ‚îÄ‚îÄ */
    .coll-hero {
      position: relative; overflow: hidden;
      min-height: 260px;
      display: flex; align-items: flex-end;
    }
    .coll-hero-bg {
      position: absolute; inset: 0; z-index: 0;
      background: linear-gradient(135deg, #08081a 0%, #0f0c2a 50%, #10091e 100%);
    }
    .coll-hero-bg img {
      width: 100%; height: 100%; object-fit: cover;
      opacity: .35; filter: blur(2px);
    }
    .coll-hero-overlay {
      position: absolute; inset: 0; z-index: 1;
      background: linear-gradient(to top, rgba(10,10,10,1) 0%, rgba(10,10,10,.4) 60%, transparent 100%);
    }
    .coll-hero-content {
      position: relative; z-index: 2;
      width: 100%; max-width: 860px; margin: 0 auto;
      padding: 2rem 1.5rem 2rem;
      display: flex; gap: 1.5rem; align-items: flex-end;
    }
    .coll-cover-img {
      width: 110px; height: 155px; border-radius: 12px; flex-shrink: 0;
      object-fit: cover; box-shadow: 0 8px 32px rgba(0,0,0,.6);
      border: 2px solid rgba(255,255,255,.12);
    }
    .coll-cover-placeholder {
      width: 110px; height: 155px; border-radius: 12px; flex-shrink: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex; align-items: center; justify-content: center;
      font-size: 2.8rem;
      box-shadow: 0 8px 32px rgba(102,126,234,.4);
    }
    .coll-hero-info { flex: 1; min-width: 0; }
    .coll-hero-info h1 {
      font-size: 1.8rem; font-weight: 800; line-height: 1.2;
      margin-bottom: .4rem;
    }
    .coll-hero-desc {
      font-size: .88rem; color: var(--text-2); margin-bottom: .85rem;
      max-width: 500px; line-height: 1.5;
    }
    .coll-hero-meta {
      display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;
    }
    .coll-owner {
      display: flex; align-items: center; gap: .5rem;
      color: var(--text-2); font-size: .82rem; font-weight: 500;
    }
    .coll-owner-ava {
      width: 28px; height: 28px; border-radius: 50%; overflow: hidden;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex; align-items: center; justify-content: center;
      font-size: .75rem; font-weight: 700; flex-shrink: 0;
    }
    .coll-owner-ava img { width: 100%; height: 100%; object-fit: cover; }
    .coll-owner:hover { color: #818cf8; }
    .coll-stat { font-size: .8rem; color: var(--text-3); display: flex; align-items: center; gap: .3rem; }

    /* ‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∞ –ª–∞–π–∫–∞ ‚îÄ‚îÄ */
    .btn-like {
      display: inline-flex; align-items: center; gap: .4rem;
      padding: .45rem 1rem; border-radius: 20px; border: 1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.06); color: var(--text-2);
      font-size: .82rem; font-weight: 600; cursor: pointer;
      transition: all .2s; font-family: inherit;
    }
    .btn-like:hover { border-color: #ef4444; color: #ef4444; background: rgba(239,68,68,.08); }
    .btn-like.liked { background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.4); color: #ef4444; }
    .btn-like:disabled { opacity: .4; cursor: not-allowed; }

    /* ‚îÄ‚îÄ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ‚îÄ‚îÄ */
    .coll-container {
      max-width: 860px; margin: 0 auto; padding: 1.5rem;
    }

    /* ‚îÄ‚îÄ –°–µ—Ç–∫–∞ –º–∞–Ω–≥–∏ ‚îÄ‚îÄ */
    .manga-grid-coll {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 1rem;
    }
    @media (min-width: 500px) { .manga-grid-coll { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); } }
    @media (min-width: 768px) { .manga-grid-coll { grid-template-columns: repeat(auto-fill, minmax(165px, 1fr)); } }

    .mcard {
      position: relative; border-radius: 12px; overflow: hidden;
      background: var(--card2); border: 1px solid var(--border);
      cursor: pointer; transition: transform .2s, border-color .2s;
    }
    .mcard:hover { transform: translateY(-4px); border-color: rgba(102,126,234,.4); }
    .mcard-img {
      width: 100%; aspect-ratio: 2/3; object-fit: cover; display: block;
    }
    .mcard-info { padding: .55rem .65rem .65rem; }
    .mcard-title {
      font-size: .78rem; font-weight: 600; color: #e4e4e7;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .mcard-meta { font-size: .7rem; color: var(--text-3); margin-top: .15rem; }

    /* ‚îÄ‚îÄ –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚îÄ‚îÄ */
    .empty-state {
      text-align: center; padding: 3rem 1rem; color: var(--text-3);
    }
    .empty-state-icon { font-size: 2.5rem; margin-bottom: .75rem; }
    .empty-state-text { font-size: .9rem; }

    /* ‚îÄ‚îÄ –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ ‚îÄ‚îÄ */
    .breadcrumbs {
      display: flex; align-items: center; gap: .4rem;
      font-size: .8rem; color: var(--text-3); margin-bottom: 1.2rem;
    }
    .breadcrumbs a { color: var(--text-3); transition: color .15s; }
    .breadcrumbs a:hover { color: #818cf8; }
    .breadcrumbs span { color: var(--text-2); }

    /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(60px);
      background: #27272a; border: 1px solid rgba(255,255,255,.1); border-radius: 12px;
      padding: 10px 18px; font-size: 13px; font-weight: 600;
      opacity: 0; transition: all .3s; z-index: 9000; white-space: nowrap;
      pointer-events: none;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast.success { border-color: rgba(74,222,128,.3); color: #4ade80; }
    .toast.error { border-color: rgba(239,68,68,.3); color: #ef4444; }
  </style>
</head>
<body>

{% set g_active = '' %}{% include 'header.html' %}

<div class="page-wrap">

  <!-- Hero -->
  <div class="coll-hero">
    <div class="coll-hero-bg">
      {% if coll.cover_url %}
        <img src="{{ coll.cover_url }}" alt="">
      {% endif %}
    </div>
    <div class="coll-hero-overlay"></div>
    <div class="coll-hero-content">
      {% if coll.cover_url %}
        <img src="{{ coll.cover_url }}" class="coll-cover-img" alt="">
      {% else %}
        <div class="coll-cover-placeholder">üìÅ</div>
      {% endif %}
      <div class="coll-hero-info">
        <h1>{{ coll.name }}</h1>
        {% if coll.description %}
          <div class="coll-hero-desc">{{ coll.description }}</div>
        {% endif %}
        <div class="coll-hero-meta">
          <a href="/profile/{{ coll.user_id }}" class="coll-owner">
            <div class="coll-owner-ava">
              {% if coll.owner_avatar %}
                <img src="{{ coll.owner_avatar }}" alt="">
              {% else %}
                {{ (owner_name or '?')[0]|upper }}
              {% endif %}
            </div>
            {{ owner_name }}
          </a>
          <div class="coll-stat">üìö {{ coll.items_count }} –º–∞–Ω–≥</div>
          <button class="btn-like{% if my_like %} liked{% endif %}"
                  id="likeBtn"
                  {% if not user_id %}disabled title="–í–æ–π–¥–∏ —á—Ç–æ–±—ã –ª–∞–π–∫–∞—Ç—å"{% endif %}
                  onclick="toggleLike()">
            <span id="likeIcon">{% if my_like %}‚ù§Ô∏è{% else %}ü§ç{% endif %}</span>
            <span id="likeCount">{{ coll.likes_count }}</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="coll-container">
    <div class="breadcrumbs">
      <a href="/collections/top">–ö–æ–ª–ª–µ–∫—Ü–∏–∏</a>
      <span>‚Ä∫</span>
      <a href="/profile/{{ coll.user_id }}">{{ owner_name }}</a>
      <span>‚Ä∫</span>
      <span style="color:var(--text)">{{ coll.name }}</span>
    </div>

    {% if items %}
      <div class="manga-grid-coll">
        {% for m in items %}
          <div class="mcard" onclick="location.href='/manga/{{ m.manga_slug }}'">
            <img src="{{ m.cover_url }}" class="mcard-img"
                 onerror="this.src='https://via.placeholder.com/130x195/1a1a1a/667eea'"
                 loading="lazy" alt="{{ m.manga_title }}">
            <div class="mcard-info">
              <div class="mcard-title">{{ m.manga_title }}</div>
              <div class="mcard-meta">{{ m.manga_type or '' }}</div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-state">
        <div class="empty-state-icon">üì≠</div>
        <div class="empty-state-text">–í –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç –º–∞–Ω–≥–∏</div>
      </div>
    {% endif %}
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const COLL_ID = {{ coll.id }};
const USER_ID = {{ user_id | tojson }};
let myLike = {{ 'true' if my_like else 'false' }};
let likeCount = {{ coll.likes_count }};

function toast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + (type || '');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

async function toggleLike() {
  if (!USER_ID) return;
  const btn = document.getElementById('likeBtn');
  btn.disabled = true;
  try {
    const method = myLike ? 'DELETE' : 'POST';
    const r = await fetch(`/api/collections/${COLL_ID}/like`, { method });
    const d = await r.json();
    if (d.success) {
      myLike = !myLike;
      likeCount = d.likes_count;
      document.getElementById('likeIcon').textContent = myLike ? '‚ù§Ô∏è' : 'ü§ç';
      document.getElementById('likeCount').textContent = likeCount;
      btn.className = 'btn-like' + (myLike ? ' liked' : '');
      toast(myLike ? '–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' : '–£–±—Ä–∞–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'success');
    } else {
      toast(d.error || '–û—à–∏–±–∫–∞', 'error');
    }
  } catch(e) {
    toast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
  }
  btn.disabled = false;
}
</script>
</body>
</html>
